<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ZESTORE - Saldo Sederhana</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:Inter,Segoe UI,system-ui;}
    body{background:#071021;color:#e6eef8;padding:20px;display:flex;flex-direction:column;align-items:center;}
    .card{width:100%;max-width:720px;background:#0f1724;padding:18px;border-radius:10px;border:1px solid #112034;margin-bottom:14px;}
    h1,h2{color:#8fd1ff;margin-bottom:10px}
    p.muted{color:#9fb4c9;font-size:.95rem}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{display:block;color:#cfe9ff;margin-top:8px;font-size:.9rem}
    input[type="text"],input[type="number"]{width:100%;padding:8px;border-radius:8px;border:1px solid #172433;background:#071223;color:#e6eef8}
    button{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
    .btn-primary{background:#2b8cff;color:white}
    .btn-danger{background:#ff6b6b;color:white}
    ul{list-style:none;padding-left:0;max-height:240px;overflow:auto}
    li.tx{padding:8px;border-bottom:1px solid #0d2433;color:#cfe9ff}
    small.meta{color:#9fb4c9}
    .muted-box{background:#09121a;padding:10px;border-radius:8px;border:1px solid #0d2533;color:#9fb4c9}
    .flex-between{display:flex;justify-content:space-between;align-items:center}
    .center{display:flex;justify-content:center}
  </style>
</head>
<body>
  <div class="card">
    <div class="flex-between">
      <h1>ZESTORE â€” Saldo (Firestore)</h1>
      <div><small class="muted">Simple balance system â€” no device storage</small></div>
    </div>

    <div id="info" class="muted-box">
      <div><strong>Username:</strong> <span id="displayName">-</span></div>
      <div><strong>Email:</strong> <span id="email">-</span></div>
      <div><strong>UID:</strong> <span id="uid">-</span></div>
    </div>

  </div>

  <div class="card">
    <h2>Saldo Kamu</h2>
    <p style="font-size:2rem">ðŸª™ <span id="balanceDisplay">0</span></p>
    <p class="muted">Histori transaksi (terbaru 50):</p>
    <ul id="txList"><li class="muted">Memuat...</li></ul>
  </div>

  <div class="card" id="adminCard" style="display:none">
    <h2>Admin â€” Adjust Saldo & Lihat Histori UID</h2>

    <div class="row">
      <div style="flex:1">
        <label>UID target</label>
        <input id="admUid" type="text" placeholder="Masukkan UID target (contoh: viCOs...)" />
      </div>

      <div style="width:180px">
        <label>Jumlah (+ / -)</label>
        <input id="admAmount" type="number" placeholder="contoh: 1000 atau -500" />
      </div>

      <div style="width:220px">
        <label>Alasan</label>
        <input id="admReason" type="text" placeholder="misal: koreksi / refund / bonus" />
      </div>
    </div>

    <div style="margin-top:10px" class="row">
      <button id="admApply" class="btn-primary">Proses Adjust</button>
      <button id="admView" class="btn-primary" style="background:#3bd67a">Lihat Saldo & Histori UID</button>
      <button id="admRefresh" class="btn-danger">Refresh Statistik</button>
    </div>

    <div style="margin-top:12px">
      <p class="muted">Statistik singkat:</p>
      <div class="row">
        <div class="muted-box" style="flex:1"><strong>Total akun:</strong> <span id="admTotalUsers">-</span></div>
        <div class="muted-box" style="flex:1"><strong>Jumlah saldo total:</strong> <span id="admTotalBalances">-</span></div>
      </div>
    </div>

    <div style="margin-top:12px">
      <p class="muted">Histori UID yang dilihat:</p>
      <ul id="admTxList"><li class="muted">Belum memilih UID</li></ul>
    </div>
  </div>

  <!-- Firebase + logic -->
  <script type="module">
    // jangan pake localStorage untuk saldo. Semua di Firestore.
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection,
      getDocs, query, orderBy, limit, runTransaction, serverTimestamp
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    // CONFIG - ganti kalau perlu
    const firebaseConfig = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Ubah sesuai UID admin lo
    const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';

    // DOM
    const displayNameEl = document.getElementById('displayName');
    const emailEl = document.getElementById('email');
    const uidEl = document.getElementById('uid');
    const balanceDisplay = document.getElementById('balanceDisplay');
    const txList = document.getElementById('txList');

    const adminCard = document.getElementById('adminCard');
    const admUid = document.getElementById('admUid');
    const admAmount = document.getElementById('admAmount');
    const admReason = document.getElementById('admReason');
    const admApply = document.getElementById('admApply');
    const admView = document.getElementById('admView');
    const admRefresh = document.getElementById('admRefresh');
    const admTotalUsers = document.getElementById('admTotalUsers');
    const admTotalBalances = document.getElementById('admTotalBalances');
    const admTxList = document.getElementById('admTxList');

    let currentUser = null;

    // helper format
    const nf = v => (Number(v)||0).toLocaleString('id-ID');

    // ensure a balance doc exists for a uid (with amount 0)
    async function ensureBalanceDoc(uid, displayName = '-'){
      const ref = doc(db, 'balances', uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, {
          amount: 0,
          displayName: displayName || '-',
          createdAt: serverTimestamp()
        });
      }
    }

    // load current user's balance & history
    async function loadMyBalanceAndHistory(uid){
      balanceDisplay.textContent = '...';
      txList.innerHTML = '<li class="muted">Memuat...</li>';
      try{
        const bRef = doc(db, 'balances', uid);
        const bSnap = await getDoc(bRef);
        const amt = bSnap.exists() ? Number(bSnap.data().amount || 0) : 0;
        balanceDisplay.textContent = nf(amt);

        // load last 50 tx
        const txCol = collection(bRef, 'transactions');
        const q = query(txCol, orderBy('timestamp','desc'), limit(50));
        const snaps = await getDocs(q);
        txList.innerHTML = '';
        if(snaps.empty) txList.innerHTML = '<li class="muted">Belum ada histori</li>';
        snaps.forEach(s=>{
          const d = s.data();
          const ts = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString('id-ID') : '-';
          const amt = Number(d.amount||0);
          const who = d.by ? `by ${d.by}` : (d.source||'-');
          txList.innerHTML += `<li class="tx"><strong>${amt>0?'+':''}${nf(amt)}</strong> â€” <small class="meta">${d.type||'adjust'} â€¢ ${who} â€¢ ${ts}</small><br/><small class="meta">${d.reason?('reason: '+d.reason):''}</small></li>`;
        });
      }catch(e){
        console.error(e);
        txList.innerHTML = `<li class="muted">Error memuat: ${e.message||e}</li>`;
      }
    }

    // admin: adjust target uid balance by delta (positive/negative). logs transaction
    async function adminAdjust(targetUid, delta, reason = ''){
      if(!currentUser || currentUser.uid !== ADMIN_UID) throw new Error('Bukan admin.');
      if(!targetUid) throw new Error('Masukkan UID target.');
      if(!Number.isFinite(delta) || delta === 0) throw new Error('Jumlah harus bukan 0.');

      const targetRef = doc(db, 'balances', targetUid);
      await runTransaction(db, async tx=>{
        const tSnap = await tx.get(targetRef);
        if(!tSnap.exists()){
          // create doc when missing
          tx.set(targetRef, { amount: 0, displayName: '-', createdAt: serverTimestamp() });
        }
        const cur = (await tx.get(targetRef)).data().amount || 0;
        const after = Number(cur) + Number(delta);
        if(after < 0) throw new Error('Operasi akan membuat saldo negatif (dilarang).');

        // update balance
        tx.update(targetRef, { amount: after, updatedAt: serverTimestamp() });

        // add transaction record
        tx.set(doc(collection(targetRef, 'transactions')), {
          timestamp: serverTimestamp(),
          amount: delta,
          type: 'admin-adjust',
          by: currentUser.uid,
          reason: reason || ''
        });
      });
    }

    // admin: load stats (count users and sum balances) - note: costs read of many docs
    async function adminLoadStats(){
      admTotalUsers.textContent = '...';
      admTotalBalances.textContent = '...';
      try{
        const col = collection(db, 'balances');
        const snaps = await getDocs(col);
        let totalUsers = 0;
        let totalBalances = 0;
        snaps.forEach(s=>{
          totalUsers++;
          totalBalances += Number(s.data().amount || 0);
        });
        admTotalUsers.textContent = nf(totalUsers);
        admTotalBalances.textContent = nf(totalBalances);
      }catch(e){
        console.error(e);
        admTotalUsers.textContent = '-';
        admTotalBalances.textContent = 'Error';
      }
    }

    // admin: view target uid balance + last 100 transactions
    async function adminViewUid(targetUid){
      admTxList.innerHTML = '<li class="muted">Memuat...</li>';
      if(!targetUid){ admTxList.innerHTML = '<li class="muted">Masukkan UID dulu.</li>'; return; }
      try{
        const tRef = doc(db, 'balances', targetUid);
        const snap = await getDoc(tRef);
        if(!snap.exists()){ admTxList.innerHTML = '<li class="muted">UID tidak ditemukan.</li>'; return; }

        const bal = Number(snap.data().amount || 0);
        admTxList.innerHTML = `<li class="muted">Saldo sekarang: <strong>${nf(bal)}</strong></li>`;

        const q = query(collection(tRef, 'transactions'), orderBy('timestamp','desc'), limit(100));
        const txSnaps = await getDocs(q);
        if(txSnaps.empty){ admTxList.innerHTML += '<li class="muted">Belum ada histori</li>'; return; }
        txSnaps.forEach(ts=>{
          const d = ts.data();
          const time = d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString('id-ID') : '-';
          admTxList.innerHTML += `<li class="tx">${d.amount>0?'+':''}${nf(d.amount)} â€” <small class="meta">${d.type||'tx'} â€¢ ${d.by||d.source||'-'} â€¢ ${time}</small><br/><small class="meta">${d.reason||''}</small></li>`;
        });
      }catch(e){
        console.error(e);
        admTxList.innerHTML = `<li class="muted">Error: ${e.message||e}</li>`;
      }
    }

    // --- UI events
    admApply.addEventListener('click', async ()=>{
      const target = admUid.value.trim();
      const amount = Number(admAmount.value || 0);
      const reason = admReason.value.trim();
      if(!target){ alert('Isi UID target'); return; }
      if(!amount){ alert('Isi jumlah (bukan 0)'); return; }
      if(!confirm(`Yakin ${amount>0?'TAMBAH':'KURANGI'} ${nf(amount)} ke UID ${target}?`)) return;
      try{
        await adminAdjust(target, amount, reason);
        alert('Sukses adjust saldo.');
        admAmount.value = '';
        admReason.value = '';
        await adminLoadStats();
        // kalau admin melihat UID yang sama, refresh
        if(admUid.value.trim() === target) await adminViewUid(target);
      }catch(e){
        alert('Gagal: ' + (e.message || e));
      }
    });

    admView.addEventListener('click', async ()=>{
      const target = admUid.value.trim();
      await adminViewUid(target);
    });

    admRefresh.addEventListener('click', adminLoadStats);

    // --- auth
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href = '/register-login';
      currentUser = user;

      displayNameEl.textContent = user.displayName || '-';
      emailEl.textContent = user.email || '-';
      uidEl.textContent = user.uid;

      // ensure user doc exists
      await ensureBalanceDoc(user.uid, user.displayName || user.email || '-');

      // show admin UI if admin
      if(user.uid === ADMIN_UID) {
        adminCard.style.display = 'block';
        await adminLoadStats();
      } else {
        adminCard.style.display = 'none';
      }

      // load balance & history for current user
      await loadMyBalanceAndHistory(user.uid);
    });

    // optional logout - keep behavior consistent with your other pages
    // add a global click handler to logout if needed (not shown in UI)
    window.doLogout = () => signOut(auth).then(()=>{ location.href = '/register-login'; });

  </script>
</body>
</html>
