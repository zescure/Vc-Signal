<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ZESTORE - ZCoin Ekonomi Baru</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
    body{background:#0a0a0f;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px;}
    header{width:100%;max-width:500px;background:#111927;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222;margin-bottom:20px;}
    .logo{font-size:20px;color:#00bfff;font-weight:bold;}
    .card{width:100%;max-width:500px;background:#141b2d;padding:20px;border:1px solid #2c3e50;border-radius:10px;margin-bottom:16px;}
    .coin-display{font-size:2rem;color:#ffd700;text-align:center;}
    button{cursor:pointer;border:none;border-radius:6px;padding:10px 12px;}
    .primary{background:#4c8bf5;color:#fff;}
    .danger{background:#e74c3c;color:#fff;}
    .muted{color:#ccc;font-size:.9rem;}
    .economy-row{display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #1e2537;}
    input{width:100%;padding:8px;border-radius:6px;border:none;margin-top:6px;}
    .admin-mini{background:#0f1724;padding:12px;border-radius:8px;margin-top:8px;}
    ul{list-style:none;padding-left:0;}
    .btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
    .btn-row button{flex:1;min-width:140px;}
  </style>
</head>
<body>
  <header>
    <div class="logo">ZESTORE.ID - ZCoin (baru)</div>
    <div class="muted">Beta</div>
  </header>

  <div class="card">
    <h2>Info Akun</h2>
    <p><strong>Username:</strong> <span id="displayName">â€“</span></p>
    <p><strong>Email:</strong> <span id="email">â€“</span></p>
    <p><strong>UID:</strong> <span id="uid">â€“</span></p>
    <button id="logoutBtn" class="danger">Logout</button>
  </div>

  <div class="card">
    <h3>Saldo ZCoin (ZRC2)</h3>
    <p class="coin-display">ðŸª™ <span id="coinBalance">0</span></p>
    <p class="muted">â‰ˆ Rp <span id="coinBalanceIDR">0</span></p>

    <div class="btn-row">
      <button id="btnDeposit" class="primary">Deposit</button>
      <button id="btnWithdraw" class="danger">Penarikan</button>
    </div>

    <div class="btn-row">
      <button id="openTransfer" class="primary">Transfer Koin</button>
    </div>

    <p class="muted" style="margin-top:8px;">
      Deposit = ambil dari suplai terkunci â†’ masuk saldo user. <br/>
      Penarikan = saldo user â†’ balik ke suplai terkunci.
    </p>
  </div>

  <div class="card">
    <h3>Ekonomi Koin</h3>
    <div class="economy-row"><span>Total Supply (terkunci)</span><strong id="totalSupply">0</strong></div>
    <div class="economy-row"><span>Suplai Beredar</span><strong id="circulatingSupply">0</strong></div>
    <div class="economy-row"><span>Suplai Terkunci</span><strong id="lockedSupply">0</strong></div>
    <div class="economy-row"><span>Kurs Dinamis (10 koin)</span><strong id="dynamicRate">Rp 0</strong></div>
    <p class="muted" style="margin-top:8px;">Catatan: sistem menyimpan koin baru di koleksi <code>zcoin_balances</code>.</p>
  </div>

  <!-- Deposit/Withdraw popup -->
  <div id="dwPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:999;">
    <div style="background:#141828;padding:18px;border-radius:10px;width:340px;">
      <h3 id="dwTitle">Deposit</h3>
      <p class="muted" style="margin-top:6px" id="dwDesc">Dump top up dulu (simulasi).</p>

      <label style="margin-top:10px;display:block;">Jumlah (koin)</label>
      <input id="dwAmount" type="number" placeholder="contoh: 500" />

      <p class="muted" id="dwMsg" style="margin-top:8px;"></p>

      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="dwConfirm" class="primary">Proses</button>
        <button id="dwCancel" class="danger">Batal</button>
      </div>
    </div>
  </div>

  <!-- Transfer popup -->
  <div id="transferPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:999;">
    <div style="background:#141828;padding:18px;border-radius:10px;width:320px;">
      <h3>Transfer ZCoin</h3>
      <label>UID Penerima</label>
      <input id="transferUid" placeholder="uid penerima" />
      <label>Jumlah (koin)</label>
      <input id="transferAmt" type="number" placeholder="Jumlah" />
      <p class="muted" id="transferMsg"></p>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="transferBtn" class="primary">Kirim</button>
        <button id="closeTransfer" class="danger">Batal</button>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <h3>Histori ZCoin</h3>
    <ul id="txHistory"></ul>
  </div>

  <!-- Admin (hidden default) -->
  <div class="card" id="adminBox" style="display:none;">
    <h2>Admin - ZCoin</h2>
    <div class="admin-mini">
      <p>Total user terdaftar: <span id="admTotalUser">0</span></p>
      <p>Total koin beredar (sum balances): <span id="admTotalCoins">0</span></p>
      <p class="muted">Top holders:</p>
      <ul id="admTop"></ul>
    </div>

    <hr style="border:none;border-top:1px solid #1e2537;margin:10px 0;">

    <h3>Mint / Burn (Admin)</h3>
    <label>UID target</label>
    <input id="admTarget" placeholder="uid target" />
    <label>Jumlah (+mint / -burn)</label>
    <input id="admQty" type="number" placeholder="contoh: 1000 atau -500" />
    <label>Alasan</label>
    <input id="admReason" placeholder="alasan" />
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="admApply" class="primary">Proses</button>
      <button id="admRefresh" class="muted">Refresh</button>
    </div>
    <p class="muted" id="admStatus"></p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection,
      getDocs, query, orderBy, limit, runTransaction, serverTimestamp,
      onSnapshot
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // -------------------- ECONOMY CONFIG --------------------
    const TOTAL_SUPPLY = 500_000_000_000;
    const ZCOIN_META_REF = doc(db, 'zcoin', 'meta');
    const ZCOIN_BALANCES = 'zcoin_balances';
    const INITIAL_AIRDROP = 1000;
    const RATE_IDR_PER_10 = 10;
    const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
    const FEE_RECEIVER_UID = ADMIN_UID;

    // -------------------- DOM --------------------
    const displayNameEl = document.getElementById('displayName');
    const emailEl       = document.getElementById('email');
    const uidEl         = document.getElementById('uid');
    const coinEl        = document.getElementById('coinBalance');
    const coinIDREl     = document.getElementById('coinBalanceIDR');
    const totalSupplyEl = document.getElementById('totalSupply');
    const circSupplyEl  = document.getElementById('circulatingSupply');
    const lockedEl      = document.getElementById('lockedSupply');
    const dynamicRateEl = document.getElementById('dynamicRate');
    const txHistoryUl   = document.getElementById('txHistory');

    const openTransfer  = document.getElementById('openTransfer');
    const transferPopup = document.getElementById('transferPopup');
    const closeTransfer = document.getElementById('closeTransfer');
    const transferBtn   = document.getElementById('transferBtn');
    const transferMsg   = document.getElementById('transferMsg');

    // Deposit/Withdraw UI
    const btnDeposit = document.getElementById('btnDeposit');
    const btnWithdraw = document.getElementById('btnWithdraw');
    const dwPopup = document.getElementById('dwPopup');
    const dwTitle = document.getElementById('dwTitle');
    const dwDesc = document.getElementById('dwDesc');
    const dwAmount = document.getElementById('dwAmount');
    const dwMsg = document.getElementById('dwMsg');
    const dwConfirm = document.getElementById('dwConfirm');
    const dwCancel = document.getElementById('dwCancel');

    // admin
    const adminBox      = document.getElementById('adminBox');
    const admTotalUser  = document.getElementById('admTotalUser');
    const admTotalCoins = document.getElementById('admTotalCoins');
    const admTop        = document.getElementById('admTop');
    const admTarget     = document.getElementById('admTarget');
    const admQty        = document.getElementById('admQty');
    const admReason     = document.getElementById('admReason');
    const admApply      = document.getElementById('admApply');
    const admRefresh    = document.getElementById('admRefresh');
    const admStatus     = document.getElementById('admStatus');

    let currentUser = null;
    let unsubMeta = null;

    // -------------------- HELPERS --------------------
    const nf = n => (n||0).toLocaleString('id-ID');

    async function ensureZcoinMeta(){
      const snap = await getDoc(ZCOIN_META_REF);
      if(!snap.exists()){
        await setDoc(ZCOIN_META_REF, {
          totalSupply: TOTAL_SUPPLY,
          circulatingSupply: 0,
          dynamicRatePer10: RATE_IDR_PER_10,
          bankLiquidityIDR: 100000,
          createdAt: serverTimestamp()
        });
      } else {
        const d = snap.data();
        const needs = {};
        if(typeof d.totalSupply !== 'number') needs.totalSupply = TOTAL_SUPPLY;
        if(typeof d.circulatingSupply !== 'number') needs.circulatingSupply = 0;
        if(typeof d.dynamicRatePer10 !== 'number') needs.dynamicRatePer10 = RATE_IDR_PER_10;
        if(Object.keys(needs).length) await updateDoc(ZCOIN_META_REF, needs);
      }
    }

    function subscribeMetaRealtime(){
      if(unsubMeta) unsubMeta();
      unsubMeta = onSnapshot(ZCOIN_META_REF, snap=>{
        if(!snap.exists()) return;
        const d = snap.data();
        totalSupplyEl.textContent = nf(d.totalSupply || TOTAL_SUPPLY);
        const circ = Number(d.circulatingSupply || 0);
        circSupplyEl.textContent = nf(circ);
        lockedEl.textContent = nf((d.totalSupply || TOTAL_SUPPLY) - circ);
        dynamicRateEl.textContent = `Rp ${nf(d.dynamicRatePer10 || RATE_IDR_PER_10)} (10 koin)`;
      });
    }

    async function ensureUserZBalance(uid, displayName = '-'){
      const balRef = doc(db, ZCOIN_BALANCES, uid);
      const snap = await getDoc(balRef);
      if(snap.exists()) return;

      if(INITIAL_AIRDROP > 0){
        await runTransaction(db, async tx=>{
          const metaSnap = await tx.get(ZCOIN_META_REF);
          if(!metaSnap.exists()) throw new Error('ZCoin meta missing.');
          const meta = metaSnap.data();

          const total = meta.totalSupply || TOTAL_SUPPLY;
          const circ = meta.circulatingSupply || 0;
          const locked = total - circ;

          if(INITIAL_AIRDROP > locked) throw new Error('Tidak cukup supply untuk airdrop awal.');

          tx.set(balRef, {
            amount: INITIAL_AIRDROP,
            createdAt: serverTimestamp(),
            displayName: displayName || '-'
          });

          tx.set(doc(collection(balRef, 'transactions')), {
            timestamp: serverTimestamp(),
            amount: INITIAL_AIRDROP,
            type: 'airdrop',
            note: 'onboarding-airdrop'
          });

          tx.update(ZCOIN_META_REF, { circulatingSupply: circ + INITIAL_AIRDROP });
        });
      } else {
        await setDoc(balRef, { amount: 0, createdAt: serverTimestamp(), displayName: displayName || '-' });
      }
    }

    async function getDynamicRatePer10(){
      const snap = await getDoc(ZCOIN_META_REF);
      return snap.exists() ? Number(snap.data().dynamicRatePer10 || RATE_IDR_PER_10) : RATE_IDR_PER_10;
    }

    async function loadZBalance(uid){
      const balRef = doc(db, ZCOIN_BALANCES, uid);
      const snap = await getDoc(balRef);
      const amt = snap.exists() ? Number(snap.data().amount || 0) : 0;
      coinEl.textContent = nf(amt);
      coinIDREl.textContent = nf(Math.round((amt/10) * (await getDynamicRatePer10())));
      await loadTxHistory(uid);
    }

    async function loadTxHistory(uid){
      txHistoryUl.innerHTML = '<li class="muted">Memuat...</li>';
      try{
        const txCol = collection(doc(db, ZCOIN_BALANCES, uid), 'transactions');
        const q = query(txCol, orderBy('timestamp','desc'), limit(50));
        const snaps = await getDocs(q);
        txHistoryUl.innerHTML = '';
        if(snaps.empty) txHistoryUl.innerHTML = '<li class="muted">Belum ada histori</li>';
        snaps.forEach(d=>{
          const t = d.data();
          const dt = t.timestamp?.toDate?.().toLocaleString('id-ID') || '-';
          const amt = Number(t.amount || 0);
          const cls = amt>0 ? 'color: #2ecc71;' : 'color: #e74c3c;';
          txHistoryUl.innerHTML += `<li style="${cls}padding:6px 0;border-bottom:1px solid #1e2537;">${dt} â†’ ${amt>0?'+':''}${nf(amt)} koin <small style="color:#999">(${t.type||'-'})</small></li>`;
        });
      }catch(e){
        txHistoryUl.innerHTML = `<li class="muted">Gagal memuat: ${e.message || e}</li>`;
      }
    }

    // -------------------- DEPOSIT / WITHDRAW (NEW) --------------------
    let dwMode = 'deposit'; // 'deposit' | 'withdraw'

    function openDW(mode){
      dwMode = mode;
      dwMsg.textContent = '';
      dwAmount.value = '';
      dwPopup.style.display = 'flex';

      if(mode === 'deposit'){
        dwTitle.textContent = 'Deposit ZCoin';
        dwDesc.textContent = 'Dump top up dulu (simulasi). Deposit akan memindahkan supply terkunci â†’ saldo user.';
        dwConfirm.textContent = 'Deposit';
        dwConfirm.className = 'primary';
      } else {
        dwTitle.textContent = 'Penarikan ZCoin';
        dwDesc.textContent = 'Dump withdraw dulu (simulasi). Penarikan akan memindahkan saldo user â†’ supply terkunci.';
        dwConfirm.textContent = 'Tarik';
        dwConfirm.className = 'danger';
      }
    }

    function closeDW(){
      dwPopup.style.display = 'none';
      dwMsg.textContent = '';
      dwAmount.value = '';
    }

    btnDeposit.onclick = ()=> openDW('deposit');
    btnWithdraw.onclick = ()=> openDW('withdraw');
    dwCancel.onclick = closeDW;

    dwConfirm.onclick = async ()=>{
      dwMsg.textContent = '';
      if(!currentUser){ dwMsg.textContent = 'Belum login.'; return; }

      const qty = Math.floor(Number(dwAmount.value || 0));
      if(!qty || qty <= 0){
        dwMsg.textContent = 'Jumlah harus > 0';
        return;
      }

      const uid = currentUser.uid;
      const userRef = doc(db, ZCOIN_BALANCES, uid);
      const metaRef = ZCOIN_META_REF;

      dwMsg.textContent = 'Memproses...';

      try{
        await runTransaction(db, async tx=>{
          const metaSnap = await tx.get(metaRef);
          const userSnap = await tx.get(userRef);

          if(!metaSnap.exists()) throw new Error('Meta ZCoin tidak ditemukan.');
          if(!userSnap.exists()) throw new Error('Wallet user tidak ditemukan.');

          const meta = metaSnap.data();
          const total = Number(meta.totalSupply || TOTAL_SUPPLY);
          const circ  = Number(meta.circulatingSupply || 0);
          const locked = total - circ;

          const curBal = Number(userSnap.data().amount || 0);

          if(dwMode === 'deposit'){
            // Deposit: locked -> user, circulating++
            if(qty > locked) throw new Error('Locked supply tidak cukup untuk deposit segitu.');

            tx.update(userRef, { amount: curBal + qty, updatedAt: serverTimestamp() });
            tx.set(doc(collection(userRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: +qty,
              type: 'deposit',
              note: 'simulated-topup'
            });
            tx.update(metaRef, { circulatingSupply: circ + qty });

          } else {
            // Withdraw: user -> locked, circulating--
            if(curBal < qty) throw new Error('Saldo user tidak cukup untuk penarikan segitu.');

            tx.update(userRef, { amount: curBal - qty, updatedAt: serverTimestamp() });
            tx.set(doc(collection(userRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: -qty,
              type: 'withdraw',
              note: 'simulated-withdraw'
            });
            tx.update(metaRef, { circulatingSupply: circ - qty });
          }
        });

        dwMsg.textContent = 'Sukses.';
        await loadZBalance(currentUser.uid);
        if(currentUser.uid === ADMIN_UID) await loadAdminDashboard();

        setTimeout(()=> closeDW(), 500);
      }catch(e){
        dwMsg.textContent = 'Error: ' + (e?.message || e);
      }
    };

    // -------------------- ADMIN --------------------
    async function loadAdminDashboard(){
      try{
        const col = collection(db, ZCOIN_BALANCES);
        const snaps = await getDocs(col);
        const arr = [];
        let totalCoins = 0;
        let totalUsers = 0;
        snaps.forEach(s=>{
          totalUsers++;
          const d = s.data();
          const amt = Number(d.amount || 0);
          totalCoins += amt;
          arr.push({ uid: s.id, amount: amt, displayName: d.displayName || '-' });
        });
        arr.sort((a,b)=>b.amount - a.amount);
        admTotalUser.textContent = nf(totalUsers);
        admTotalCoins.textContent = nf(totalCoins);
        admTop.innerHTML = '';
        arr.slice(0,20).forEach(u=>{
          const li = document.createElement('li');
          li.innerHTML = `${u.uid} â€” ${nf(u.amount)} koin`;
          admTop.appendChild(li);
        });
      }catch(e){
        admStatus.textContent = 'Gagal muat admin: ' + (e?.message || e);
      }
    }

    admApply.onclick = async ()=>{
      if(!currentUser || currentUser.uid !== ADMIN_UID){
        admStatus.textContent = 'Bukan admin.';
        return;
      }
      const target = (admTarget.value||'').trim();
      const qty = Number((admQty.value||'').trim());
      const reason = (admReason.value||'').trim() || 'admin-action';
      if(!target || !Number.isFinite(qty) || qty === 0){
        admStatus.textContent = 'Isi UID & jumlah yang valid.';
        return;
      }
      admStatus.textContent = 'Memproses...';

      const targetRef = doc(db, ZCOIN_BALANCES, target);
      const metaRef = ZCOIN_META_REF;

      try{
        await runTransaction(db, async tx=>{
          const metaSnap = await tx.get(metaRef);
          if(!metaSnap.exists()) throw new Error('ZCoin meta tidak ditemukan.');
          const meta = metaSnap.data();
          const circ = Number(meta.circulatingSupply || 0);
          const locked = (meta.totalSupply || TOTAL_SUPPLY) - circ;

          const tSnap = await tx.get(targetRef);
          const curBal = tSnap.exists() ? Number(tSnap.data().amount || 0) : 0;

          if(qty > 0){
            if(qty > locked) throw new Error('Tidak cukup supply terkunci untuk mint.');
            tx.set(targetRef, { amount: curBal + qty, updatedAt: serverTimestamp() }, { merge: true });
            tx.set(doc(collection(targetRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: qty,
              type: 'mint',
              by: currentUser.uid,
              reason
            });
            tx.update(metaRef, { circulatingSupply: circ + qty });
          } else {
            const burn = Math.abs(qty);
            if(curBal < burn) throw new Error('Saldo user tidak cukup untuk burn.');
            tx.update(targetRef, { amount: curBal - burn, updatedAt: serverTimestamp() });
            tx.set(doc(collection(targetRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: -burn,
              type: 'burn',
              by: currentUser.uid,
              reason
            });
            tx.update(metaRef, { circulatingSupply: circ - burn });
          }
        });

        admStatus.textContent = 'Sukses.';
        await loadAdminDashboard();
      }catch(e){
        admStatus.textContent = 'Gagal: ' + (e?.message || e);
      }
    };

    admRefresh.onclick = ()=>loadAdminDashboard();

    // -------------------- TRANSFER --------------------
    openTransfer.onclick = ()=>{ transferPopup.style.display='flex'; transferMsg.textContent=''; };
    closeTransfer.onclick = ()=>{ transferPopup.style.display='none'; };

    transferBtn.onclick = async ()=>{
      transferMsg.textContent = '';
      if(!currentUser) { transferMsg.textContent = 'Belum login.'; return; }
      const fromUid = currentUser.uid;
      const toUid = (document.getElementById('transferUid').value||'').trim();
      const amt = Math.floor(Number(document.getElementById('transferAmt').value||0));
      if(!toUid || !amt || amt <= 0){ transferMsg.textContent = 'Isi UID & jumlah benar.'; return; }
      if(toUid === fromUid){ transferMsg.textContent = 'Tidak bisa transfer ke diri sendiri.'; return; }

      const fee = Math.ceil(amt * 0.01) + 10;

      const fromRef = doc(db, ZCOIN_BALANCES, fromUid);
      const toRef   = doc(db, ZCOIN_BALANCES, toUid);
      const feeRef  = doc(db, ZCOIN_BALANCES, FEE_RECEIVER_UID);

      transferMsg.textContent = 'Memproses transfer...';
      try{
        await runTransaction(db, async tx=>{
          const [fsnap, tsnap, fsnapFee] = await Promise.all([tx.get(fromRef), tx.get(toRef), tx.get(feeRef)]);
          if(!fsnap.exists()) throw new Error('Pengirim belum punya saldo ZCoin (cek onboarding).');
          if(!tsnap.exists()) throw new Error('Penerima tidak ditemukan.');
          if(!fsnapFee.exists()) throw new Error('Fee receiver belum tersedia.');

          const fromBal = Number(fsnap.data().amount || 0);
          const toBal   = Number(tsnap.data().amount || 0);
          const feeBal  = Number(fsnapFee.data().amount || 0);

          if(fromBal - amt - fee < 10) throw new Error('Saldo tidak cukup (minimal sisa 10 koin).');

          tx.update(fromRef, { amount: fromBal - amt - fee, updatedAt: serverTimestamp() });
          tx.update(toRef,   { amount: toBal + amt, updatedAt: serverTimestamp() });
          tx.update(feeRef,  { amount: feeBal + fee, updatedAt: serverTimestamp() });

          tx.set(doc(collection(fromRef, 'transactions')), { timestamp: serverTimestamp(), amount: -(amt+fee), to: toUid, type: 'transfer-out' });
          tx.set(doc(collection(toRef, 'transactions')),   { timestamp: serverTimestamp(), amount: +amt, from: fromUid, type: 'transfer-in' });
          tx.set(doc(collection(feeRef, 'transactions')),  { timestamp: serverTimestamp(), amount: +fee, from: fromUid, type: 'fee' });
        });

        transferMsg.textContent = 'Transfer sukses!';
        await loadZBalance(currentUser.uid);
        transferPopup.style.display = 'none';
        if(currentUser.uid === ADMIN_UID) await loadAdminDashboard();
      }catch(e){
        transferMsg.textContent = 'Error: ' + (e?.message || e);
      }
    };

    // -------------------- AUTH & INIT --------------------
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href = '/register-login';
      currentUser = user;

      displayNameEl.textContent = localStorage.getItem('username') || user.displayName || '-';
      emailEl.textContent       = user.email || '-';
      uidEl.textContent         = user.uid;

      await ensureZcoinMeta();
      subscribeMetaRealtime();

      await ensureUserZBalance(user.uid, user.displayName || user.email || '-');
      await loadZBalance(user.uid);

      if(user.uid === ADMIN_UID){
        adminBox.style.display = 'block';
        await loadAdminDashboard();
      } else {
        adminBox.style.display = 'none';
      }
    });

    document.getElementById('logoutBtn').onclick = ()=> signOut(auth).then(()=>{
      localStorage.removeItem('username');
      location.href='/register-login';
    });

    // -------------------- DYNAMIC RATE (optional) --------------------
    async function recalcDynamicRate(){
      try{
        const metaSnap = await getDoc(ZCOIN_META_REF);
        if(!metaSnap.exists()) return;
        const meta = metaSnap.data();
        const bank = Number(meta.bankLiquidityIDR || 0);
        const circ = Number(meta.circulatingSupply || 0);
        let per10 = RATE_IDR_PER_10;
        if(circ > 0) per10 = Math.max(1, Math.round((bank / circ) * 10));
        if(per10 !== (meta.dynamicRatePer10 || 0)){
          await updateDoc(ZCOIN_META_REF, { dynamicRatePer10: per10 });
        }
      }catch(e){}
    }
    setInterval(recalcDynamicRate, 10_000);
  </script>
</body>
</html>
