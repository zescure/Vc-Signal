<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LIONOR Chat</title>
  <style>
    :root{
      --bg:#0e0f11;
      --panel:#1a1d24;
      --accent:#00ffe7;
      --muted:#252932;
      --card:#20242f;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      -webkit-font-smoothing:antialiased;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--panel);
      padding: 12px 56px;
      text-align: center;
      font-size: 1.2em;
      color: var(--accent);
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 20;
    }

    /* side menu */
    #menuBtn {
      position: fixed;
      top: 8px;
      left: 8px;
      width: 48px;
      height: 48px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--accent);
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 0;
    }
    #sideMenu {
      position: fixed;
      top: 0;
      left: -100%;
      width: 320px;
      height: 100vh;
      background: var(--panel);
      overflow-y: auto;
      z-index: 29;
      transition: left 0.28s ease;
      box-shadow: 6px 0 18px rgba(0,0,0,0.6);
    }
    #sideMenu.open { left: 0; }
    .menu-header {
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #444;
      color: var(--accent);
      text-align: center;
      position: sticky;
      top:0;
      background: var(--panel);
      z-index: 1;
    }
    #sideMenu ul { list-style: none; padding: 0; margin: 0; padding-top: 8px; }
    #sideMenu li { padding: 14px 18px; border-bottom: 1px solid #333; cursor: pointer; color:#cfeee8; }
    #sideMenu li:hover{ background:#2b2f34 }

    /* chat area */
    #chat {
      flex: 1;
      padding: 84px 18px 120px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 86%;
      padding: 12px 14px;
      border-radius: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 14px;
    }
    .user { align-self: flex-end; background: var(--accent); color: #061014; font-weight: 700; }
    .ai { align-self: flex-start; background: var(--card); color: #d8e9e6; }

    /* input area */
    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      background: #16181f;
      border-top: 1px solid #222;
      z-index: 20;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .left-controls {
      display:flex;
      gap:8px;
      align-items:center;
    }
    #openSettingsBtn {
      width:44px;
      height:44px;
      border-radius:10px;
      border:none;
      background:var(--muted);
      color:var(--accent);
      font-size:22px;
      cursor:pointer;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: #252932;
      color: #fff;
      font-size: 15px;
      outline: none;
    }
    button.sendBtn {
      padding: 10px 16px;
      background-color: var(--accent);
      color: #071015;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
    }

    /* jump down button */
    #jumpBtn {
      position: fixed;
      right: 18px;
      bottom: 90px;
      width:44px;
      height:44px;
      border-radius:50%;
      border:none;
      background:var(--accent);
      color:#071015;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 25;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      cursor:pointer;
    }

    /* settings popup (no language choices) */
    #settingsPopup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(0.98);
      width: 92%;
      max-width: 520px;
      background: linear-gradient(180deg,#121416, #17181b);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      z-index: 60;
      display: none;
    }
    #settingsPopup.open { display: block; transform: translate(-50%,-50%) scale(1); }
    .row { display:flex; gap:10px; align-items:center; margin:8px 0; }
    label { color:#aef9e9; font-size:13px; width:110px; }
    select, .smallInput {
      padding:8px 10px; border-radius:8px; border:none; background:#252932; color:#fff; flex:1;
    }
    .popup-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn.ghost { background:transparent; color:#9fffe7; border:1px solid #274; }
    .btn.primary { background:var(--accent); color:#071015; font-weight:700; }

    .boldSpan { font-weight:700; display:inline; }

    @media (min-width:720px){
      header { font-size:1.25em; padding-left:72px; padding-right:72px; }
      #sideMenu { width:340px; }
      #settingsPopup { max-width:640px; }
    }
  </style>
</head>
<body>
  <header>LIONOR3 AI Beta</header>

  <button id="menuBtn" title="Menu">â˜°</button>
  <nav id="sideMenu" aria-hidden="true">
    <div class="menu-header">Lionor AI</div>

    <div style="padding:12px;">
      <div style="color:#9fffe7; margin-bottom:8px">Mode aktif: <span id="sideActiveMode">Normal</span></div>
      <div style="color:#9fffe7">Model aktif: <span id="sideActiveModel">llama-3.3-70b</span></div>
    </div>

    <ul>
      <li onclick="alert('ðŸ‘¤ Pemilik Lionor: Zezy â€” developer & trader muda yang membangun AI ini dari nol.')">Profil Pemilik</li>
      <li onclick="alert('ðŸ›°ï¸ Tentang Lionor: Lionor AI adalah asisten AI lokal. Zezy membangun konsep & UI.')">Tentang Kami</li>
      <li onclick="alert('ðŸ” Privasi: Pertanyaan diproses oleh server untuk jawaban.')">Kebijakan Privasi</li>
      <li onclick="alert('ðŸ‡®ðŸ‡© Dukungan: Terima kasih sudah dukung pengembangan AI lokal.')">Support AI Lokal</li>
    </ul>
  </nav>

  <div id="chat" aria-live="polite"></div>

  <button id="jumpBtn" title="Lompat ke pesan yang sedang digenerate">â¬‡</button>

  <div id="input-area">
    <div class="left-controls">
      <button id="openSettingsBtn" title="Mode & Model">+</button>
    </div>

    <input type="text" id="pertanyaan" placeholder="Tulis pesan..." autocomplete="off" />
    <button class="sendBtn" id="sendBtn">Kirim</button>
  </div>

  <!-- settings popup: removed bahasa settings -->
  <div id="settingsPopup" role="dialog" aria-modal="true" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="font-weight:700; color:var(--accent)">Pengaturan Mode Lionor</div>
    </div>

    <div class="row">
      <label for="popupMode">Mode</label>
      <select id="popupMode" class="smallInput">
        <option value="tothepoint">To The Point (Cepat)</option>
        <option value="normal">Normal</option>
        <option value="analisis">Analisis</option>
        <option value="deep">Deep Research (Lambat)</option>
        <option value="santai">Santai (Warkop style)</option>
        <option value="curhat">Curhat (Pendengar)</option>
      </select>
    </div>

    <div class="row">
      <label for="popupModel">Model</label>
      <select id="popupModel" class="smallInput">
        <option value="llama-3.3-70b">llama-3.3-70b</option>
        <option value="llama-3-small">llama-3-small</option>
        <option value="gpt-style">gpt-style</option>
      </select>
    </div>

    <div class="row">
      <label for="popupSpeed">Kecepatan</label>
      <select id="popupSpeed" class="smallInput">
        <option value="6">Sangat Cepat</option>
        <option value="10">Cepat</option>
        <option value="14">Normal</option>
        <option value="28">Lambat</option>
      </select>
    </div>

    <div style="margin-top:6px; color:#aef9e9; font-size:13px">
      Catatan: Bahasa default tetap Bahasa Indonesia.
    </div>

    <div class="popup-footer">
      <button class="btn ghost" id="cancelSettings">Batal</button>
      <button class="btn primary" id="saveSettings">Simpan</button>
    </div>
  </div>

  <script>
    console.log('hallo king zezy');

    // elements
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const chat = document.getElementById('chat');
    const input = document.getElementById('pertanyaan');
    const sendBtn = document.getElementById('sendBtn');
    const openSettingsBtn = document.getElementById('openSettingsBtn');
    const settingsPopup = document.getElementById('settingsPopup');
    const popupMode = document.getElementById('popupMode');
    const popupModel = document.getElementById('popupModel');
    const popupSpeed = document.getElementById('popupSpeed');
    const saveSettings = document.getElementById('saveSettings');
    const cancelSettings = document.getElementById('cancelSettings');
    const sideActiveMode = document.getElementById('sideActiveMode');
    const sideActiveModel = document.getElementById('sideActiveModel');
    const jumpBtn = document.getElementById('jumpBtn');

    // session-only settings (no localStorage)
    let currentMode = 'normal';
    let currentModel = 'llama-3.3-70b';
    let currentSpeed = 14; // ms per char

    // in-memory daily counter (session-only)
    let jumlahPertanyaan = 0;
    const LIMIT_HARIAN = 200;

    // menu toggle
    menuBtn.addEventListener('click', () => {
      const wasOpen = sideMenu.classList.contains('open');
      if (wasOpen) {
        sideMenu.classList.remove('open');
        menuBtn.textContent = 'â˜°';
        sideMenu.setAttribute('aria-hidden','true');
      } else {
        sideMenu.classList.add('open');
        menuBtn.textContent = 'Ã—';
        sideMenu.setAttribute('aria-hidden','false');
      }
    });

    // open settings
    openSettingsBtn.addEventListener('click', () => {
      // reflect current session settings
      popupMode.value = currentMode;
      popupModel.value = currentModel;
      popupSpeed.value = String(currentSpeed);
      settingsPopup.classList.add('open');
      settingsPopup.setAttribute('aria-hidden','false');
    });
    cancelSettings.addEventListener('click', () => {
      settingsPopup.classList.remove('open');
      settingsPopup.setAttribute('aria-hidden','true');
    });
    saveSettings.addEventListener('click', () => {
      currentMode = popupMode.value;
      currentModel = popupModel.value;
      currentSpeed = parseInt(popupSpeed.value, 10) || 14;
      sideActiveMode.textContent = popupMode.options[popupMode.selectedIndex].text;
      sideActiveModel.textContent = currentModel;
      settingsPopup.classList.remove('open');
      settingsPopup.setAttribute('aria-hidden','true');
    });

    // helpers: bold parsing & typing
    function parseBoldSegments(text) {
      const segments = [];
      let idx = 0;
      const regex = /\(\*\*(.*?)\*\*\)/g;
      let m;
      while ((m = regex.exec(text)) !== null) {
        const before = text.slice(idx, m.index);
        if (before) segments.push({text: before, bold: false});
        segments.push({text: m[1], bold: true});
        idx = m.index + m[0].length;
      }
      const tail = text.slice(idx);
      if (tail) segments.push({text: tail, bold: false});
      return segments;
    }

    async function typeWithBold(container, message, speed = 14) {
      container.innerHTML = '';
      const segments = parseBoldSegments(message);
      const spanElems = segments.map(seg => {
        const sp = document.createElement('span');
        if (seg.bold) sp.className = 'boldSpan';
        sp.dataset.full = seg.text;
        sp.textContent = '';
        container.appendChild(sp);
        return sp;
      });
      for (let i=0;i<spanElems.length;i++){
        const sp = spanElems[i];
        const full = sp.dataset.full;
        for (let j=0;j<full.length;j++){
          sp.textContent += full.charAt(j);
          if ((chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 60) chat.scrollTop = chat.scrollHeight;
          await new Promise(r => setTimeout(r, speed));
        }
      }
    }

    function isAtBottom() {
      return (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 60;
    }

    function updateJumpButton() {
      const gen = chat.querySelector('.msg[data-generating="true"]');
      const shouldShow = !!gen && !isAtBottom();
      jumpBtn.style.display = shouldShow ? 'flex' : 'none';
    }
    chat.addEventListener('scroll', updateJumpButton);
    window.addEventListener('resize', updateJumpButton);
    jumpBtn.addEventListener('click', () => {
      const gen = chat.querySelector('.msg[data-generating="true"]') || chat.querySelector('.msg.ai:last-of-type');
      if (gen) gen.scrollIntoView({behavior:'smooth', block:'center'});
    });

    // quick local replies
    function autoReplyLocal(q) {
      const pert = q.toLowerCase().trim();
      if (pert === "hallo lionor" || pert === "halo lionor") return "Hallo juga! aku LIONOR AI Milik Zezy! Ada yang mau kamu tanyain hari ini?";
      if (pert.includes("siapa pemilik lionor")) return "LIONOR AI Beta adalah karya dari seorang kreator independen bernama Zezy.";
      if (pert.includes("lionor ai dari mana")) return "Lionor AI berasal dari Indonesiaâ€”dibangun dengan semangat lokal yang kental.";
      return null;
    }

    // santai style
    function applySantaiStyle(text) {
      if (!text || typeof text !== 'string') return text;
      if (text.includes('```')) {
        if (!/^(\s*bro[,!:]?\s*)/i.test(text)) return 'Bro, ' + text;
        return text;
      }
      let t = text;
      t = t.replace(/\bAku\b/g, 'Gua').replace(/\baku\b/g, 'gua');
      t = t.replace(/\bSaya\b/g, 'Gua').replace(/\bsaya\b/g, 'gua');
      t = t.replace(/\bKamu\b/g, 'Elu').replace(/\bkamu\b/g, 'elu');
      t = t.replace(/\bAnda\b/g, 'Elu').replace(/\banda\b/gi, 'elu');
      if (!/^(\s*(bro|bro,|bro:|bro!|bro\.)\s*)/i.test(t)) {
        t = 'Bro, ' + t;
      }
      return t;
    }

    // curhat style + safety
    function applyCurhatStyle(text) {
      if (!text || typeof text !== 'string') return text;
      const dangerWords = ['bunuh diri','ingin bunuh','ingin mati','bunuh','putus asa','nyerah'];
      const lower = text.toLowerCase();
      for (const w of dangerWords) {
        if (lower.includes(w)) {
          return "Bro, gua denger lu lagi ngerasa berat banget. Kalau lu lagi dalam bahaya atau punya pikiran buat nyakitin diri, tolong segera kontak layanan darurat atau orang terdekat. Lu mau cerita apa dulu? Gua dengerin.";
        }
      }
      let t = text;
      if (!/^\s*(bro|bro,|bro:|bro!)/i.test(t)) {
        t = 'Bro, ' + t;
      }
      t = t.replace(/\b(anda harus|kamu harus)\b/gi, 'mungkin coba');
      return t;
    }

    // response builder tolerant
    function buildAnswerFromResponse(parsedOrText) {
      if (!parsedOrText) return "âš ï¸ Lionor gak ngerti. Coba tanya lagi ya.";
      if (typeof parsedOrText === 'object') {
        if (parsedOrText.answer) return parsedOrText.answer;
        if (parsedOrText.message) return parsedOrText.message;
        if (parsedOrText.choices && Array.isArray(parsedOrText.choices) && parsedOrText.choices.length) {
          const ch = parsedOrText.choices[0];
          return ch.message?.content || ch.text || JSON.stringify(parsedOrText).slice(0,1200);
        }
        return JSON.stringify(parsedOrText).slice(0,1200);
      }
      return parsedOrText;
    }

    // mode speed map
    const modeSpeedMap = {
      'tothepoint': 6,
      'normal': 14,
      'analisis': 20,
      'deep': 28,
      'santai': 10,
      'curhat': 12
    };

    // main send (no localStorage, no conversation persistence)
    async function sendMessage() {
      const teks = input.value.trim();
      if (!teks) return;

      if (jumlahPertanyaan >= LIMIT_HARIAN) {
        const warn = document.createElement('div');
        warn.className = 'msg ai';
        chat.appendChild(warn);
        await typeWithBold(warn, "âš ï¸ Anda telah melebihi batas harian (sesi).", 6);
        return;
      }

      jumlahPertanyaan++;

      // show user msg
      const userMsg = document.createElement('div');
      userMsg.className = 'msg user';
      userMsg.textContent = teks;
      chat.appendChild(userMsg);
      chat.scrollTop = chat.scrollHeight;

      input.value = '';
      input.focus();

      // quick local reply
      const quick = autoReplyLocal(teks);
      if (quick) {
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai';
        chat.appendChild(aiMsg);
        await typeWithBold(aiMsg, quick, 6);
        return;
      }

      // placeholder
      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg ai';
      aiMsg.dataset.generating = 'true';
      chat.appendChild(aiMsg);
      chat.scrollTop = chat.scrollHeight;
      updateJumpButton();

      // choose speed: explicit setting (session) > mode map
      const speed = currentSpeed || (modeSpeedMap[currentMode] || 14);

      aiMsg.textContent = 'â³ Lionor mikir...';
      chat.scrollTop = chat.scrollHeight;

      try {
        // prefer GET (server likely supports q param). If your server expects POST, replace with POST version.
        const mode = encodeURIComponent(currentMode);
        const model = encodeURIComponent(currentModel);
        const url = `/.netlify/functions/ask?q=${encodeURIComponent(teks)}&mode=${mode}&model=${model}`;

        const controller = new AbortController();
        const timeoutMap = { 'tothepoint': 15000, 'normal': 30000, 'analisis': 45000, 'deep': 90000, 'santai': 30000, 'curhat': 45000 };
        const timeoutMs = timeoutMap[currentMode] || 30000;
        const timeout = setTimeout(() => controller.abort(), timeoutMs);

        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeout);

        let raw = '';
        try { raw = await res.text(); } catch(e){ raw = ''; }
        let parsed = null;
        try { parsed = raw ? JSON.parse(raw) : null; } catch(e){ parsed = null; }

        let answer = buildAnswerFromResponse(parsed || raw);

        // post-process modes
        if (currentMode === 'santai') answer = applySantaiStyle(answer);
        if (currentMode === 'curhat') answer = applyCurhatStyle(answer);

        await typeWithBold(aiMsg, answer, speed);

      } catch (err) {
        const errMsg = (err && err.name === 'AbortError') ? 'âš ï¸ Permintaan timeout (terlalu lama).' : (`âš ï¸ Gagal ambil jawaban: ${err.message || err}`);
        await typeWithBold(aiMsg, errMsg, 8);
      } finally {
        delete aiMsg.dataset.generating;
        updateJumpButton();
        if (isAtBottom()) chat.scrollTop = chat.scrollHeight;
      }
    }

    // keyboard Enter
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
    });
    sendBtn.addEventListener('click', sendMessage);

    // initial UI reflect
    popupMode.value = currentMode;
    popupModel.value = currentModel;
    popupSpeed.value = String(currentSpeed);

    // expose debug
    window._lionor = {
      sendMessage,
      setMode: (m) => { currentMode = m; popupMode.value = m; sideActiveMode.textContent = popupMode.options[popupMode.selectedIndex]?.text || m; },
      setModel: (m) => { currentModel = m; popupModel.value = m; sideActiveModel.textContent = m; }
    };

    // periodically update jump button
    setInterval(updateJumpButton, 600);

    // autofocus
    input.focus();
  </script>
</body>
</html>
