<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>ZESTORE - ZCoin Ekonomi Baru</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Segoe UI',sans-serif;}
    body{background:#0a0a0f;color:#fff;display:flex;flex-direction:column;align-items:center;padding:20px;}
    header{width:100%;max-width:500px;background:#111927;padding:15px 20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #222;margin-bottom:20px;}
    .logo{font-size:20px;color:#00bfff;font-weight:bold;}
    .card{width:100%;max-width:500px;background:#141b2d;padding:20px;border:1px solid #2c3e50;border-radius:10px;margin-bottom:16px;}
    .coin-display{font-size:2rem;color:#ffd700;text-align:center;}
    button{cursor:pointer;border:none;border-radius:6px;padding:10px 12px;}
    .primary{background:#4c8bf5;color:#fff;}
    .danger{background:#e74c3c;color:#fff;}
    .muted{color:#ccc;font-size:.9rem;}
    .economy-row{display:flex;justify-content:space-between;padding:8px 0;border-top:1px solid #1e2537;}
    input{width:100%;padding:8px;border-radius:6px;border:none;margin-top:6px;}
    .admin-mini{background:#0f1724;padding:12px;border-radius:8px;margin-top:8px;}
    ul{list-style:none;padding-left:0;}
    .btn-row{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;}
    .btn-row button{flex:1;min-width:140px;}

    .pill{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-size:12px;
      background:#0f1724;
      border:1px solid #1e2537;
      color:#ccc;
    }
    .pill.pending{border-color:#f1c40f;color:#f1c40f;}
    .pill.approved{border-color:#2ecc71;color:#2ecc71;}
    .pill.rejected{border-color:#e74c3c;color:#e74c3c;}
    .row{display:flex;justify-content:space-between;gap:10px;align-items:center;}
    .mini{font-size:12px;color:#9aa;}
    .divider{border:none;border-top:1px solid #1e2537;margin:10px 0;}

    .list-item{
      padding:10px 0;
      border-bottom:1px solid #1e2537;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">ZESTORE.ID - ZCoin (baru)</div>
    <div class="muted">Beta</div>
  </header>

  <div class="card">
    <h2>Info Akun</h2>
    <p><strong>Username:</strong> <span id="displayName">â€“</span></p>
    <p><strong>Email:</strong> <span id="email">â€“</span></p>
    <p><strong>UID:</strong> <span id="uid">â€“</span></p>
    <button id="logoutBtn" class="danger">Logout</button>
  </div>

  <div class="card">
    <h3>Saldo ZCoin (ZRC2)</h3>
    <p class="coin-display">ðŸª™ <span id="coinBalance">0</span></p>
    <p class="muted">â‰ˆ Rp <span id="coinBalanceIDR">0</span></p>

    <div class="btn-row">
      <button id="btnDeposit" class="primary">Deposit</button>
      <button id="btnWithdraw" class="danger">Penarikan</button>
    </div>

    <div class="btn-row">
      <button id="openTransfer" class="primary">Transfer Koin</button>
    </div>

    <p class="muted" style="margin-top:8px;">
      Deposit/Penarikan sekarang <b>PENDING</b> sampai admin approve.
    </p>
  </div>

  <div class="card">
    <h3>Ekonomi Koin</h3>
    <div class="economy-row"><span>Total Supply (terkunci)</span><strong id="totalSupply">0</strong></div>
    <div class="economy-row"><span>Suplai Beredar</span><strong id="circulatingSupply">0</strong></div>
    <div class="economy-row"><span>Suplai Terkunci</span><strong id="lockedSupply">0</strong></div>
    <div class="economy-row"><span>Kurs Dinamis (10 koin)</span><strong id="dynamicRate">Rp 0</strong></div>
    <p class="muted" style="margin-top:8px;">Catatan: sistem menyimpan koin di koleksi <code>zcoin_balances</code>.</p>
  </div>

  <!-- Deposit/Withdraw popup -->
  <div id="dwPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:999;">
    <div style="background:#141828;padding:18px;border-radius:10px;width:340px;">
      <h3 id="dwTitle">Deposit</h3>
      <p class="muted" style="margin-top:6px" id="dwDesc">Dump top up dulu (simulasi).</p>

      <label style="margin-top:10px;display:block;">Jumlah (koin)</label>
      <input id="dwAmount" type="number" placeholder="contoh: 500" />

      <p class="muted" id="dwMsg" style="margin-top:8px;"></p>

      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="dwConfirm" class="primary">Kirim Request</button>
        <button id="dwCancel" class="danger">Batal</button>
      </div>
    </div>
  </div>

  <!-- Transfer popup -->
  <div id="transferPopup" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:999;">
    <div style="background:#141828;padding:18px;border-radius:10px;width:320px;">
      <h3>Transfer ZCoin</h3>
      <label>UID Penerima</label>
      <input id="transferUid" placeholder="uid penerima" />
      <label>Jumlah (koin)</label>
      <input id="transferAmt" type="number" placeholder="Jumlah" />
      <p class="muted" id="transferMsg"></p>
      <div style="display:flex;gap:8px;margin-top:10px;">
        <button id="transferBtn" class="primary">Kirim</button>
        <button id="closeTransfer" class="danger">Batal</button>
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="card">
    <h3>Histori ZCoin</h3>
    <ul id="txHistory"></ul>
  </div>

  <!-- Requests -->
  <div class="card">
    <h3>Request Deposit / Penarikan</h3>
    <p class="muted" style="margin-top:6px;">
      Ini daftar request kamu yang masih pending / sudah diproses admin.
    </p>
    <ul id="reqHistory" style="margin-top:10px;"></ul>
  </div>

  <!-- CLOSED TRADES / REALIZED PNL (OUTPUT SYMBOL + PRICE + PNL) -->
  <div class="card">
    <h3>Histori Perdagangan Tertutup (Realized PnL)</h3>
    <p class="muted" style="margin-top:6px;">
      Output: <b>Symbol</b>, <b>Close Price</b>, <b>Last Price</b>, dan <b>Realized PnL</b>.
    </p>
    <ul id="closedTrades" style="margin-top:10px;"></ul>
  </div>

  <!-- Admin (hidden default) -->
  <div class="card" id="adminBox" style="display:none;">
    <h2>Admin - ZCoin</h2>
    <div class="admin-mini">
      <p>Total user terdaftar: <span id="admTotalUser">0</span></p>
      <p>Total koin beredar (sum balances): <span id="admTotalCoins">0</span></p>
      <p class="muted">Top holders:</p>
      <ul id="admTop"></ul>
    </div>

    <hr class="divider">

    <h3>Pending Request (Deposit / Withdraw)</h3>
    <p class="muted">Admin approve dulu baru saldo beneran pindah.</p>
    <ul id="admReqList" style="margin-top:10px;"></ul>
    <p class="muted" id="admReqStatus" style="margin-top:8px;"></p>

    <hr class="divider">

    <h3>Mint / Burn (Admin)</h3>
    <label>UID target</label>
    <input id="admTarget" placeholder="uid target" />
    <label>Jumlah (+mint / -burn)</label>
    <input id="admQty" type="number" placeholder="contoh: 1000 atau -500" />
    <label>Alasan</label>
    <input id="admReason" placeholder="alasan" />
    <div style="display:flex;gap:8px;margin-top:8px;">
      <button id="admApply" class="primary">Proses</button>
      <button id="admRefresh" class="muted">Refresh</button>
    </div>
    <p class="muted" id="admStatus"></p>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection,
      getDocs, query, orderBy, limit, runTransaction, serverTimestamp,
      onSnapshot, addDoc, where
    } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // -------------------- CONFIG --------------------
    const TOTAL_SUPPLY = 500_000_000_000;
    const ZCOIN_META_REF = doc(db, 'zcoin', 'meta');
    const ZCOIN_BALANCES = 'zcoin_balances';
    const INITIAL_AIRDROP = 1000;
    const RATE_IDR_PER_10 = 10;
    const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';
    const FEE_RECEIVER_UID = ADMIN_UID;

    // NEW collections
    const REQUESTS_COL = 'zcoin_requests';

    // NEW: MARKET + POSITIONS (buat output symbol + price + realized pnl)
    const MARKETS_COL = 'markets';     // db/markets/{marketId}
    const POSITIONS_COL = 'positions'; // db/zcoin_balances/{uid}/positions/{posId} (atau global, lihat catatan)

    // -------------------- DOM --------------------
    const displayNameEl = document.getElementById('displayName');
    const emailEl       = document.getElementById('email');
    const uidEl         = document.getElementById('uid');
    const coinEl        = document.getElementById('coinBalance');
    const coinIDREl     = document.getElementById('coinBalanceIDR');
    const totalSupplyEl = document.getElementById('totalSupply');
    const circSupplyEl  = document.getElementById('circulatingSupply');
    const lockedEl      = document.getElementById('lockedSupply');
    const dynamicRateEl = document.getElementById('dynamicRate');
    const txHistoryUl   = document.getElementById('txHistory');

    const openTransfer  = document.getElementById('openTransfer');
    const transferPopup = document.getElementById('transferPopup');
    const closeTransfer = document.getElementById('closeTransfer');
    const transferBtn   = document.getElementById('transferBtn');
    const transferMsg   = document.getElementById('transferMsg');

    // Deposit/Withdraw UI
    const btnDeposit = document.getElementById('btnDeposit');
    const btnWithdraw = document.getElementById('btnWithdraw');
    const dwPopup = document.getElementById('dwPopup');
    const dwTitle = document.getElementById('dwTitle');
    const dwDesc = document.getElementById('dwDesc');
    const dwAmount = document.getElementById('dwAmount');
    const dwMsg = document.getElementById('dwMsg');
    const dwConfirm = document.getElementById('dwConfirm');
    const dwCancel = document.getElementById('dwCancel');

    // request history + closed trades
    const reqHistoryUl = document.getElementById('reqHistory');
    const closedTradesUl = document.getElementById('closedTrades');

    // admin
    const adminBox      = document.getElementById('adminBox');
    const admTotalUser  = document.getElementById('admTotalUser');
    const admTotalCoins = document.getElementById('admTotalCoins');
    const admTop        = document.getElementById('admTop');
    const admTarget     = document.getElementById('admTarget');
    const admQty        = document.getElementById('admQty');
    const admReason     = document.getElementById('admReason');
    const admApply      = document.getElementById('admApply');
    const admRefresh    = document.getElementById('admRefresh');
    const admStatus     = document.getElementById('admStatus');

    // admin pending request list
    const admReqList = document.getElementById('admReqList');
    const admReqStatus = document.getElementById('admReqStatus');

    let currentUser = null;
    let unsubMeta = null;

    // NEW: caches + unsub
    let marketsCache = {};               // { marketId: {symbol, price, name} }
    let positionsSnapshotCache = [];     // array of positions
    let unsubMarkets = null;
    let unsubPositions = null;

    // -------------------- HELPERS --------------------
    const nf = n => (n||0).toLocaleString('id-ID');
    const safeNum = v => Number.isFinite(Number(v)) ? Number(v) : 0;

    function formatPrice(x){
      const n = Number(x);
      if(!Number.isFinite(n)) return 'â€”';
      // biar rapi (emas biasanya 2 desimal)
      return n.toLocaleString('id-ID', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function pill(status){
      const s = (status || 'pending').toLowerCase();
      return `<span class="pill ${s}">${s.toUpperCase()}</span>`;
    }

    async function ensureZcoinMeta(){
      const snap = await getDoc(ZCOIN_META_REF);
      if(!snap.exists()){
        await setDoc(ZCOIN_META_REF, {
          totalSupply: TOTAL_SUPPLY,
          circulatingSupply: 0,
          dynamicRatePer10: RATE_IDR_PER_10,
          bankLiquidityIDR: 100000,
          createdAt: serverTimestamp()
        });
      } else {
        const d = snap.data();
        const needs = {};
        if(typeof d.totalSupply !== 'number') needs.totalSupply = TOTAL_SUPPLY;
        if(typeof d.circulatingSupply !== 'number') needs.circulatingSupply = 0;
        if(typeof d.dynamicRatePer10 !== 'number') needs.dynamicRatePer10 = RATE_IDR_PER_10;
        if(Object.keys(needs).length) await updateDoc(ZCOIN_META_REF, needs);
      }
    }

    function subscribeMetaRealtime(){
      if(unsubMeta) unsubMeta();
      unsubMeta = onSnapshot(ZCOIN_META_REF, snap=>{
        if(!snap.exists()) return;
        const d = snap.data();
        totalSupplyEl.textContent = nf(d.totalSupply || TOTAL_SUPPLY);
        const circ = safeNum(d.circulatingSupply || 0);
        circSupplyEl.textContent = nf(circ);
        lockedEl.textContent = nf((d.totalSupply || TOTAL_SUPPLY) - circ);
        dynamicRateEl.textContent = `Rp ${nf(d.dynamicRatePer10 || RATE_IDR_PER_10)} (10 koin)`;
      });
    }

    async function ensureUserZBalance(uid, displayName = '-'){
      const balRef = doc(db, ZCOIN_BALANCES, uid);
      const snap = await getDoc(balRef);
      if(snap.exists()) return;

      if(INITIAL_AIRDROP > 0){
        await runTransaction(db, async tx=>{
          const metaSnap = await tx.get(ZCOIN_META_REF);
          if(!metaSnap.exists()) throw new Error('ZCoin meta missing.');
          const meta = metaSnap.data();

          const total = safeNum(meta.totalSupply || TOTAL_SUPPLY);
          const circ = safeNum(meta.circulatingSupply || 0);
          const locked = total - circ;

          if(INITIAL_AIRDROP > locked) throw new Error('Tidak cukup supply untuk airdrop awal.');

          tx.set(balRef, {
            amount: INITIAL_AIRDROP,
            createdAt: serverTimestamp(),
            displayName: displayName || '-'
          });

          tx.set(doc(collection(balRef, 'transactions')), {
            timestamp: serverTimestamp(),
            amount: INITIAL_AIRDROP,
            type: 'airdrop',
            note: 'onboarding-airdrop'
          });

          tx.update(ZCOIN_META_REF, { circulatingSupply: circ + INITIAL_AIRDROP });
        });
      } else {
        await setDoc(balRef, { amount: 0, createdAt: serverTimestamp(), displayName: displayName || '-' });
      }
    }

    async function getDynamicRatePer10(){
      const snap = await getDoc(ZCOIN_META_REF);
      return snap.exists() ? safeNum(snap.data().dynamicRatePer10 || RATE_IDR_PER_10) : RATE_IDR_PER_10;
    }

    async function loadZBalance(uid){
      const balRef = doc(db, ZCOIN_BALANCES, uid);
      const snap = await getDoc(balRef);
      const amt = snap.exists() ? safeNum(snap.data().amount || 0) : 0;
      coinEl.textContent = nf(amt);
      coinIDREl.textContent = nf(Math.round((amt/10) * (await getDynamicRatePer10())));

      await loadTxHistory(uid);
      await loadRequestHistory(uid);

      // closed trades render bakal realtime dari subscribePositionsRealtime()
      // tapi kita trigger juga sekali biar ga kosong pas awal
      renderClosedTrades();
    }

    async function loadTxHistory(uid){
      txHistoryUl.innerHTML = '<li class="muted">Memuat...</li>';
      try{
        const txCol = collection(doc(db, ZCOIN_BALANCES, uid), 'transactions');
        const q = query(txCol, orderBy('timestamp','desc'), limit(50));
        const snaps = await getDocs(q);
        txHistoryUl.innerHTML = '';
        if(snaps.empty) txHistoryUl.innerHTML = '<li class="muted">Belum ada histori</li>';
        snaps.forEach(d=>{
          const t = d.data();
          const dt = t.timestamp?.toDate?.().toLocaleString('id-ID') || '-';
          const amt = safeNum(t.amount || 0);
          const cls = amt>0 ? 'color: #2ecc71;' : 'color: #e74c3c;';
          txHistoryUl.innerHTML += `<li style="${cls}padding:6px 0;border-bottom:1px solid #1e2537;">
            ${dt} â†’ ${amt>0?'+':''}${nf(amt)} koin
            <small style="color:#999">(${t.type||'-'})</small>
          </li>`;
        });
      }catch(e){
        txHistoryUl.innerHTML = `<li class="muted">Gagal memuat: ${e.message || e}</li>`;
      }
    }

    // -------------------- REQUEST HISTORY --------------------
    async function loadRequestHistory(uid){
      reqHistoryUl.innerHTML = '<li class="muted">Memuat...</li>';
      try{
        const colRef = collection(db, REQUESTS_COL);
        const q = query(colRef, where('uid','==',uid), orderBy('createdAt','desc'), limit(30));
        const snaps = await getDocs(q);

        reqHistoryUl.innerHTML = '';
        if(snaps.empty){
          reqHistoryUl.innerHTML = '<li class="muted">Belum ada request</li>';
          return;
        }

        snaps.forEach(s=>{
          const r = s.data();
          const dt = r.createdAt?.toDate?.().toLocaleString('id-ID') || '-';
          const amount = safeNum(r.amount || 0);
          const type = r.type || '-';
          const status = r.status || 'pending';
          const note = r.note || '';

          reqHistoryUl.innerHTML += `
            <li style="padding:10px 0;border-bottom:1px solid #1e2537;">
              <div class="row">
                <div>
                  <b>${type.toUpperCase()}</b> ${pill(status)}
                  <div class="mini">${dt}</div>
                </div>
                <div style="text-align:right;">
                  <b>${nf(amount)}</b> <span class="mini">koin</span>
                </div>
              </div>
              <div class="mini" style="margin-top:6px;color:#9aa;">
                ID: ${s.id}<br/>
                ${note ? ('Note: ' + note) : ''}
              </div>
            </li>
          `;
        });
      }catch(e){
        reqHistoryUl.innerHTML = `<li class="muted">Gagal memuat request: ${e.message || e}</li>`;
      }
    }

    // ==================== NEW: MARKETS + POSITIONS REALTIME ====================
    function subscribeMarketsRealtime(){
      if(unsubMarkets) unsubMarkets();

      const colRef = collection(db, MARKETS_COL);

      unsubMarkets = onSnapshot(colRef, (snap)=>{
        const tmp = {};
        snap.forEach(docu=>{
          const d = docu.data() || {};
          tmp[docu.id] = {
            symbol: d.symbol || d.name || docu.id,
            name: d.name || d.symbol || docu.id,
            price: safeNum(d.price || 0),
          };
        });

        marketsCache = tmp;
        renderClosedTrades();
      }, (err)=>{
        console.log('markets snapshot error', err);
      });
    }

    function subscribePositionsRealtime(uid){
      if(unsubPositions) unsubPositions();

      // Ini ngikutin pattern: positions ada di subcollection wallet user
      // zcoin_balances/{uid}/positions/{posId}
      const colRef = collection(doc(db, ZCOIN_BALANCES, uid), POSITIONS_COL);

      unsubPositions = onSnapshot(colRef, (snap)=>{
        const arr = [];
        snap.forEach(docu=>{
          const d = docu.data() || {};
          arr.push({ id: docu.id, ...d });
        });

        // simpen cache
        positionsSnapshotCache = arr;

        // render ulang
        renderClosedTrades();
      }, (err)=>{
        console.log('positions snapshot error', err);
      });
    }

    function renderClosedTrades(){
      if(!closedTradesUl) return;

      // filter closed
      const closed = (positionsSnapshotCache || []).filter(p => (p.status || '').toLowerCase() !== 'open');

      closedTradesUl.innerHTML = '';

      if(!closed.length){
        closedTradesUl.innerHTML = `<li class="muted">Belum ada histori closed trade</li>`;
        return;
      }

      // sort newest first
      closed.sort((a,b)=>{
        const ta = a.closedAt?.seconds ? a.closedAt.seconds : 0;
        const tb = b.closedAt?.seconds ? b.closedAt.seconds : 0;
        return tb - ta;
      });

      closed.slice(0,60).forEach(p=>{
        const m = marketsCache[p.marketId] || null;

        const symbol = (m && m.symbol) ? m.symbol : (p.marketName || p.marketId || 'UNKNOWN');
        const closePrice = (typeof p.closePrice === "number") ? p.closePrice : null;
        const lastPrice  = (m && typeof m.price === "number") ? m.price : null;

        // realized pnl
        const pnl = safeNum(p.pl || p.pnl || 0);

        const closedAt = p.closedAt?.toDate?.().toLocaleString('id-ID')
          || (p.closedAt?.seconds ? new Date(p.closedAt.seconds*1000).toLocaleString('id-ID') : '-');

        const pnlHtml = pnl >= 0
          ? `<span style="color:#2ecc71;font-weight:700;">+${pnl.toFixed(2)}</span>`
          : `<span style="color:#e74c3c;font-weight:700;">${pnl.toFixed(2)}</span>`;

        const li = document.createElement('li');
        li.className = 'list-item';

        li.innerHTML = `
          <div class="row">
            <div>
              <div style="font-weight:800">${symbol}</div>
              <div class="mini">
                Close: <b>${closePrice !== null ? formatPrice(closePrice) : "â€”"}</b>
                â€¢ Last: <b>${lastPrice !== null ? formatPrice(lastPrice) : "â€”"}</b>
              </div>
              <div class="mini">Closed: ${closedAt}</div>
            </div>
            <div style="text-align:right;">
              <div class="mini">Realized</div>
              <div>${pnlHtml}</div>
            </div>
          </div>
        `;

        closedTradesUl.appendChild(li);
      });
    }

    // -------------------- DEPOSIT / WITHDRAW REQUEST (PENDING) --------------------
    let dwMode = 'deposit';

    function openDW(mode){
      dwMode = mode;
      dwMsg.textContent = '';
      dwAmount.value = '';
      dwPopup.style.display = 'flex';

      if(mode === 'deposit'){
        dwTitle.textContent = 'Deposit ZCoin';
        dwDesc.textContent = 'Kirim request deposit (pending). Admin harus approve.';
        dwConfirm.textContent = 'Kirim Request Deposit';
        dwConfirm.className = 'primary';
      } else {
        dwTitle.textContent = 'Penarikan ZCoin';
        dwDesc.textContent = 'Kirim request penarikan (pending). Admin harus approve.';
        dwConfirm.textContent = 'Kirim Request Withdraw';
        dwConfirm.className = 'danger';
      }
    }

    function closeDW(){
      dwPopup.style.display = 'none';
      dwMsg.textContent = '';
      dwAmount.value = '';
    }

    btnDeposit.onclick = ()=> openDW('deposit');
    btnWithdraw.onclick = ()=> openDW('withdraw');
    dwCancel.onclick = closeDW;

    dwConfirm.onclick = async ()=>{
      dwMsg.textContent = '';
      if(!currentUser){ dwMsg.textContent = 'Belum login.'; return; }

      const qty = Math.floor(Number(dwAmount.value || 0));
      if(!qty || qty <= 0){
        dwMsg.textContent = 'Jumlah harus > 0';
        return;
      }

      dwMsg.textContent = 'Mengirim request...';

      try{
        await addDoc(collection(db, REQUESTS_COL), {
          uid: currentUser.uid,
          type: dwMode,
          amount: qty,
          status: 'pending',
          note: 'simulated',
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp()
        });

        dwMsg.textContent = 'Request terkirim. Tunggu admin approve.';
        await loadRequestHistory(currentUser.uid);
        setTimeout(()=> closeDW(), 700);
      }catch(e){
        dwMsg.textContent = 'Error: ' + (e?.message || e);
      }
    };

    // -------------------- ADMIN: LOAD PENDING REQUESTS --------------------
    async function loadAdminPendingRequests(){
      if(!currentUser || currentUser.uid !== ADMIN_UID) return;

      admReqList.innerHTML = '<li class="muted">Memuat pending request...</li>';
      admReqStatus.textContent = '';

      try{
        const colRef = collection(db, REQUESTS_COL);
        const q = query(colRef, where('status','==','pending'), orderBy('createdAt','desc'), limit(50));
        const snaps = await getDocs(q);

        admReqList.innerHTML = '';
        if(snaps.empty){
          admReqList.innerHTML = '<li class="muted">Tidak ada request pending</li>';
          return;
        }

        snaps.forEach(s=>{
          const r = s.data();
          const dt = r.createdAt?.toDate?.().toLocaleString('id-ID') || '-';
          const amount = safeNum(r.amount || 0);
          const type = (r.type || '-').toUpperCase();
          const uid = r.uid || '-';

          const li = document.createElement('li');
          li.style.padding = '10px 0';
          li.style.borderBottom = '1px solid #1e2537';

          li.innerHTML = `
            <div class="row">
              <div>
                <b>${type}</b> ${pill('pending')}
                <div class="mini">${dt}</div>
                <div class="mini">UID: ${uid}</div>
                <div class="mini">ID: ${s.id}</div>
              </div>
              <div style="text-align:right;">
                <b>${nf(amount)}</b> <span class="mini">koin</span>
              </div>
            </div>

            <div class="btn-row" style="margin-top:10px;">
              <button class="primary" data-act="approve" data-id="${s.id}">Approve</button>
              <button class="danger" data-act="reject" data-id="${s.id}">Reject</button>
            </div>
          `;

          li.querySelectorAll('button').forEach(btn=>{
            btn.onclick = async ()=>{
              const act = btn.getAttribute('data-act');
              const id = btn.getAttribute('data-id');
              if(act === 'approve') await adminApproveRequest(id);
              if(act === 'reject') await adminRejectRequest(id);
            };
          });

          admReqList.appendChild(li);
        });
      }catch(e){
        admReqList.innerHTML = `<li class="muted">Gagal muat pending: ${e.message || e}</li>`;
      }
    }

    async function adminApproveRequest(requestId){
      if(!currentUser || currentUser.uid !== ADMIN_UID){
        admReqStatus.textContent = 'Bukan admin.';
        return;
      }

      admReqStatus.textContent = 'Approve diproses...';

      const reqRef = doc(db, REQUESTS_COL, requestId);

      try{
        await runTransaction(db, async tx=>{
          const reqSnap = await tx.get(reqRef);
          if(!reqSnap.exists()) throw new Error('Request tidak ditemukan.');

          const req = reqSnap.data();
          if(req.status !== 'pending') throw new Error('Request sudah diproses.');

          const uid = req.uid;
          const amount = safeNum(req.amount || 0);
          const type = req.type;

          if(!uid || !amount || amount <= 0) throw new Error('Data request invalid.');

          const userRef = doc(db, ZCOIN_BALANCES, uid);
          const metaRef = ZCOIN_META_REF;

          const [userSnap, metaSnap] = await Promise.all([tx.get(userRef), tx.get(metaRef)]);
          if(!userSnap.exists()) throw new Error('Wallet user tidak ditemukan.');
          if(!metaSnap.exists()) throw new Error('Meta ZCoin tidak ditemukan.');

          const userBal = safeNum(userSnap.data().amount || 0);
          const meta = metaSnap.data();

          const total = safeNum(meta.totalSupply || TOTAL_SUPPLY);
          const circ  = safeNum(meta.circulatingSupply || 0);
          const locked = total - circ;

          if(type === 'deposit'){
            if(amount > locked) throw new Error('Locked supply tidak cukup untuk approve deposit.');
            tx.update(userRef, { amount: userBal + amount, updatedAt: serverTimestamp() });
            tx.set(doc(collection(userRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: +amount,
              type: 'deposit-approved',
              note: 'approved-by-admin',
              requestId
            });
            tx.update(metaRef, { circulatingSupply: circ + amount });
          }
          else if(type === 'withdraw'){
            if(userBal < amount) throw new Error('Saldo user tidak cukup untuk approve withdraw.');
            tx.update(userRef, { amount: userBal - amount, updatedAt: serverTimestamp() });
            tx.set(doc(collection(userRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: -amount,
              type: 'withdraw-approved',
              note: 'approved-by-admin',
              requestId
            });
            tx.update(metaRef, { circulatingSupply: circ - amount });
          }
          else{
            throw new Error('Tipe request tidak valid.');
          }

          tx.update(reqRef, {
            status: 'approved',
            approvedBy: currentUser.uid,
            approvedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        });

        admReqStatus.textContent = 'Approve sukses.';
        await loadAdminPendingRequests();
        await loadAdminDashboard();

        if(currentUser?.uid) await loadZBalance(currentUser.uid);

      }catch(e){
        admReqStatus.textContent = 'Gagal approve: ' + (e?.message || e);
      }
    }

    async function adminRejectRequest(requestId){
      if(!currentUser || currentUser.uid !== ADMIN_UID){
        admReqStatus.textContent = 'Bukan admin.';
        return;
      }

      admReqStatus.textContent = 'Reject diproses...';

      try{
        await runTransaction(db, async tx=>{
          const reqRef = doc(db, REQUESTS_COL, requestId);
          const reqSnap = await tx.get(reqRef);
          if(!reqSnap.exists()) throw new Error('Request tidak ditemukan.');
          const req = reqSnap.data();
          if(req.status !== 'pending') throw new Error('Request sudah diproses.');

          tx.update(reqRef, {
            status: 'rejected',
            rejectedBy: currentUser.uid,
            rejectedAt: serverTimestamp(),
            updatedAt: serverTimestamp()
          });
        });

        admReqStatus.textContent = 'Reject sukses.';
        await loadAdminPendingRequests();
      }catch(e){
        admReqStatus.textContent = 'Gagal reject: ' + (e?.message || e);
      }
    }

    // -------------------- ADMIN DASHBOARD --------------------
    async function loadAdminDashboard(){
      try{
        const col = collection(db, ZCOIN_BALANCES);
        const snaps = await getDocs(col);
        const arr = [];
        let totalCoins = 0;
        let totalUsers = 0;
        snaps.forEach(s=>{
          totalUsers++;
          const d = s.data();
          const amt = safeNum(d.amount || 0);
          totalCoins += amt;
          arr.push({ uid: s.id, amount: amt, displayName: d.displayName || '-' });
        });
        arr.sort((a,b)=>b.amount - a.amount);
        admTotalUser.textContent = nf(totalUsers);
        admTotalCoins.textContent = nf(totalCoins);
        admTop.innerHTML = '';
        arr.slice(0,20).forEach(u=>{
          const li = document.createElement('li');
          li.innerHTML = `${u.uid} â€” ${nf(u.amount)} koin`;
          admTop.appendChild(li);
        });
      }catch(e){
        admStatus.textContent = 'Gagal muat admin: ' + (e?.message || e);
      }
    }

    // Mint/Burn
    admApply.onclick = async ()=>{
      if(!currentUser || currentUser.uid !== ADMIN_UID){
        admStatus.textContent = 'Bukan admin.';
        return;
      }
      const target = (admTarget.value||'').trim();
      const qty = Number((admQty.value||'').trim());
      const reason = (admReason.value||'').trim() || 'admin-action';
      if(!target || !Number.isFinite(qty) || qty === 0){
        admStatus.textContent = 'Isi UID & jumlah yang valid.';
        return;
      }
      admStatus.textContent = 'Memproses...';

      const targetRef = doc(db, ZCOIN_BALANCES, target);
      const metaRef = ZCOIN_META_REF;

      try{
        await runTransaction(db, async tx=>{
          const metaSnap = await tx.get(metaRef);
          if(!metaSnap.exists()) throw new Error('ZCoin meta tidak ditemukan.');
          const meta = metaSnap.data();
          const circ = safeNum(meta.circulatingSupply || 0);
          const locked = (safeNum(meta.totalSupply || TOTAL_SUPPLY)) - circ;

          const tSnap = await tx.get(targetRef);
          const curBal = tSnap.exists() ? safeNum(tSnap.data().amount || 0) : 0;

          if(qty > 0){
            if(qty > locked) throw new Error('Tidak cukup supply terkunci untuk mint.');
            tx.set(targetRef, { amount: curBal + qty, updatedAt: serverTimestamp() }, { merge: true });
            tx.set(doc(collection(targetRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: qty,
              type: 'mint',
              by: currentUser.uid,
              reason
            });
            tx.update(metaRef, { circulatingSupply: circ + qty });
          } else {
            const burn = Math.abs(qty);
            if(curBal < burn) throw new Error('Saldo user tidak cukup untuk burn.');
            tx.update(targetRef, { amount: curBal - burn, updatedAt: serverTimestamp() });
            tx.set(doc(collection(targetRef, 'transactions')), {
              timestamp: serverTimestamp(),
              amount: -burn,
              type: 'burn',
              by: currentUser.uid,
              reason
            });
            tx.update(metaRef, { circulatingSupply: circ - burn });
          }
        });

        admStatus.textContent = 'Sukses.';
        await loadAdminDashboard();
      }catch(e){
        admStatus.textContent = 'Gagal: ' + (e?.message || e);
      }
    };

    admRefresh.onclick = async ()=>{
      await loadAdminDashboard();
      await loadAdminPendingRequests();
    };

    // -------------------- TRANSFER --------------------
    openTransfer.onclick = ()=>{ transferPopup.style.display='flex'; transferMsg.textContent=''; };
    closeTransfer.onclick = ()=>{ transferPopup.style.display='none'; };

    transferBtn.onclick = async ()=>{
      transferMsg.textContent = '';
      if(!currentUser) { transferMsg.textContent = 'Belum login.'; return; }
      const fromUid = currentUser.uid;
      const toUid = (document.getElementById('transferUid').value||'').trim();
      const amt = Math.floor(Number(document.getElementById('transferAmt').value||0));
      if(!toUid || !amt || amt <= 0){ transferMsg.textContent = 'Isi UID & jumlah benar.'; return; }
      if(toUid === fromUid){ transferMsg.textContent = 'Tidak bisa transfer ke diri sendiri.'; return; }

      const fee = Math.ceil(amt * 0.01) + 10;

      const fromRef = doc(db, ZCOIN_BALANCES, fromUid);
      const toRef   = doc(db, ZCOIN_BALANCES, toUid);
      const feeRef  = doc(db, ZCOIN_BALANCES, FEE_RECEIVER_UID);

      transferMsg.textContent = 'Memproses transfer...';
      try{
        await runTransaction(db, async tx=>{
          const [fsnap, tsnap, fsnapFee] = await Promise.all([tx.get(fromRef), tx.get(toRef), tx.get(feeRef)]);
          if(!fsnap.exists()) throw new Error('Pengirim belum punya saldo ZCoin (cek onboarding).');
          if(!tsnap.exists()) throw new Error('Penerima tidak ditemukan.');
          if(!fsnapFee.exists()) throw new Error('Fee receiver belum tersedia.');

          const fromBal = safeNum(fsnap.data().amount || 0);
          const toBal   = safeNum(tsnap.data().amount || 0);
          const feeBal  = safeNum(fsnapFee.data().amount || 0);

          if(fromBal - amt - fee < 10) throw new Error('Saldo tidak cukup (minimal sisa 10 koin).');

          tx.update(fromRef, { amount: fromBal - amt - fee, updatedAt: serverTimestamp() });
          tx.update(toRef,   { amount: toBal + amt, updatedAt: serverTimestamp() });
          tx.update(feeRef,  { amount: feeBal + fee, updatedAt: serverTimestamp() });

          tx.set(doc(collection(fromRef, 'transactions')), { timestamp: serverTimestamp(), amount: -(amt+fee), to: toUid, type: 'transfer-out' });
          tx.set(doc(collection(toRef, 'transactions')),   { timestamp: serverTimestamp(), amount: +amt, from: fromUid, type: 'transfer-in' });
          tx.set(doc(collection(feeRef, 'transactions')),  { timestamp: serverTimestamp(), amount: +fee, from: fromUid, type: 'fee' });
        });

        transferMsg.textContent = 'Transfer sukses!';
        await loadZBalance(currentUser.uid);
        transferPopup.style.display = 'none';
        if(currentUser.uid === ADMIN_UID){
          await loadAdminDashboard();
          await loadAdminPendingRequests();
        }
      }catch(e){
        transferMsg.textContent = 'Error: ' + (e?.message || e);
      }
    };

    // -------------------- AUTH & INIT --------------------
    onAuthStateChanged(auth, async user=>{
      if(!user) return location.href = '/register-login';
      currentUser = user;

      displayNameEl.textContent = localStorage.getItem('username') || user.displayName || '-';
      emailEl.textContent       = user.email || '-';
      uidEl.textContent         = user.uid;

      await ensureZcoinMeta();
      subscribeMetaRealtime();

      await ensureUserZBalance(user.uid, user.displayName || user.email || '-');
      await loadZBalance(user.uid);

      // NEW realtime subs (market + positions)
      subscribeMarketsRealtime();
      subscribePositionsRealtime(user.uid);

      if(user.uid === ADMIN_UID){
        adminBox.style.display = 'block';
        await loadAdminDashboard();
        await loadAdminPendingRequests();
      } else {
        adminBox.style.display = 'none';
      }
    });

    document.getElementById('logoutBtn').onclick = ()=> signOut(auth).then(()=>{
      localStorage.removeItem('username');
      location.href='/register-login';
    });

    // -------------------- DYNAMIC RATE (optional) --------------------
    async function recalcDynamicRate(){
      try{
        const metaSnap = await getDoc(ZCOIN_META_REF);
        if(!metaSnap.exists()) return;
        const meta = metaSnap.data();
        const bank = safeNum(meta.bankLiquidityIDR || 0);
        const circ = safeNum(meta.circulatingSupply || 0);
        let per10 = RATE_IDR_PER_10;
        if(circ > 0) per10 = Math.max(1, Math.round((bank / circ) * 10));
        if(per10 !== safeNum(meta.dynamicRatePer10 || 0)){
          await updateDoc(ZCOIN_META_REF, { dynamicRatePer10: per10 });
        }
      }catch(e){}
    }
    setInterval(recalcDynamicRate, 10_000);
  </script>
</body>
</html>
