<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LIONOR Chat</title>
  <style>
    :root{
      --bg:#0e0f11;
      --panel:#1a1d24;
      --accent:#00ffe7;
      --muted:#252932;
      --card:#20242f;
      --text:#fff;
    }
    *{box-sizing:border-box}
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
      -webkit-font-smoothing:antialiased;
    }
    header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: var(--panel);
      padding: 12px 56px;
      text-align: center;
      font-size: 1.2em;
      color: var(--accent);
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 20;
    }

    /* side menu */
    #menuBtn {
      position: fixed;
      top: 8px;
      left: 8px;
      width: 48px;
      height: 48px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--accent);
      font-size: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 30;
      padding: 0;
    }
    #sideMenu {
      position: fixed;
      top: 0;
      left: -100%;
      width: 320px;
      height: 100vh;
      background: var(--panel);
      overflow-y: auto;
      z-index: 29;
      transition: left 0.28s ease;
      box-shadow: 6px 0 18px rgba(0,0,0,0.6);
    }
    #sideMenu.open { left: 0; }
    .menu-header {
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #444;
      color: var(--accent);
      text-align: center;
      position: sticky;
      top:0;
      background: var(--panel);
      z-index: 1;
    }
    #sideMenu ul { list-style: none; padding: 0; margin: 0; padding-top: 8px; }
    #sideMenu li { padding: 14px 18px; border-bottom: 1px solid #333; cursor: pointer; color:#cfeee8; }
    #sideMenu li:hover{ background:#2b2f34 }

    /* chat area */
    #chat {
      flex: 1;
      padding: 84px 18px 120px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .msg {
      max-width: 86%;
      padding: 12px 14px;
      border-radius: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
      word-wrap: break-word;
      font-size: 14px;
    }
    .user { align-self: flex-end; background: var(--accent); color: #061014; font-weight: 700; }
    .ai { align-self: flex-start; background: var(--card); color: #d8e9e6; }

    /* input area */
    #input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 12px;
      background: #16181f;
      border-top: 1px solid #222;
      z-index: 20;
      display:flex;
      gap:8px;
      align-items:center;
    }
    .left-controls {
      display:flex;
      gap:8px;
      align-items:center;
    }
    #openSettingsBtn {
      width:44px;
      height:44px;
      border-radius:10px;
      border:none;
      background:var(--muted);
      color:var(--accent);
      font-size:22px;
      cursor:pointer;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 10px;
      background: #252932;
      color: #fff;
      font-size: 15px;
      outline: none;
    }
    button.sendBtn {
      padding: 10px 16px;
      background-color: var(--accent);
      color: #071015;
      font-weight: bold;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 15px;
    }

    /* jump down button */
    #jumpBtn {
      position: fixed;
      right: 18px;
      bottom: 90px;
      width:44px;
      height:44px;
      border-radius:50%;
      border:none;
      background:var(--accent);
      color:#071015;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 25;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
      cursor:pointer;
    }

    /* settings popup */
    #settingsPopup {
      position: fixed;
      left: 50%;
      top: 50%;
      transform: translate(-50%,-50%) scale(0.98);
      width: 92%;
      max-width: 520px;
      background: linear-gradient(180deg,#121416, #17181b);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      z-index: 60;
      display: none;
    }
    #settingsPopup.open { display: block; transform: translate(-50%,-50%) scale(1); }
    .row { display:flex; gap:10px; align-items:center; margin:8px 0; }
    label { color:#aef9e9; font-size:13px; width:110px; }
    select, .smallInput {
      padding:8px 10px; border-radius:8px; border:none; background:#252932; color:#fff; flex:1;
    }
    .popup-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }
    .btn { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; }
    .btn.ghost { background:transparent; color:#9fffe7; border:1px solid #274; }
    .btn.primary { background:var(--accent); color:#071015; font-weight:700; }

    /* small helpers */
    .muted { color:#9fffe7; font-size:12px }
    .boldSpan { font-weight:700; display:inline; }

    @media (min-width:720px){
      header { font-size:1.25em; padding-left:72px; padding-right:72px; }
      #sideMenu { width:340px; }
      #settingsPopup { max-width:640px; }
    }
  </style>
</head>
<body>
  <header>LIONOR3 AI Beta</header>

  <!-- side menu (toggle with menuBtn) -->
  <button id="menuBtn" title="Menu">‚ò∞</button>
  <nav id="sideMenu" aria-hidden="true">
    <div class="menu-header">Lionor AI</div>

    <div style="padding:12px;">
      <div style="color:#9fffe7; margin-bottom:8px">Mode aktif: <span id="sideActiveMode">Normal</span></div>
      <div style="color:#9fffe7">Model aktif: <span id="sideActiveModel">llama-3.3-70b</span></div>
    </div>

    <ul>
      <li onclick="alert('üë§ Pemilik Lionor: Zezy ‚Äî developer & trader muda yang membangun AI ini dari nol.')">Profil Pemilik</li>
      <li onclick="alert('üõ∞Ô∏è Tentang Lionor: Lionor AI adalah asisten AI lokal. Zezy membangun konsep & UI, sementara model besar di-backend oleh beragam provider.')">Tentang Kami</li>
      <li onclick="alert('üîê Privasi: Pertanyaan hanya diproses untuk jawaban, tidak disimpan permanen.')">Kebijakan Privasi</li>
      <li onclick="alert('üáÆüá© Dukungan: Terima kasih sudah dukung pengembangan AI lokal.')">Support AI Lokal</li>
    </ul>
  </nav>

  <!-- chat messages -->
  <div id="chat" aria-live="polite"></div>

  <!-- jump to generating message -->
  <button id="jumpBtn" title="Lompat ke pesan yang sedang digenerate">‚¨á</button>

  <!-- input area: + button (open settings), text input, send -->
  <div id="input-area">
    <div class="left-controls">
      <button id="openSettingsBtn" title="Mode & Model">+</button>
    </div>

    <input type="text" id="pertanyaan" placeholder="Tulis pesan..." autocomplete="off" />
    <button class="sendBtn" id="sendBtn">Kirim</button>
  </div>

  <!-- settings popup -->
  <div id="settingsPopup" role="dialog" aria-modal="true" aria-hidden="true">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div style="font-weight:700; color:var(--accent)">Pengaturan Mode Lionor</div>
      <div style="font-size:13px; color:#9fffe7">Bahasa default: <span id="popupLangLabel">Indonesia</span></div>
    </div>

    <div class="row">
      <label for="popupMode">Mode</label>
      <select id="popupMode" class="smallInput">
        <option value="tothepoint">To The Point (Cepat)</option>
        <option value="normal">Normal</option>
        <option value="analisis">Analisis</option>
        <option value="deep">Deep Research (Lambat)</option>
        <option value="santai">Santai (Warkop style)</option>
      </select>
    </div>

    <div class="row">
      <label for="popupModel">Model</label>
      <select id="popupModel" class="smallInput">
        <option value="llama-3.3-70b">llama-3.3-70b</option>
        <option value="llama-3-small">llama-3-small</option>
        <option value="gpt-style">gpt-style</option>
      </select>
    </div>

    <div class="row">
      <label for="popupSpeed">Kecepatan</label>
      <select id="popupSpeed" class="smallInput">
        <option value="6">Sangat Cepat</option>
        <option value="10">Cepat</option>
        <option value="14">Normal</option>
        <option value="28">Lambat</option>
      </select>
    </div>

    <div class="row">
      <label for="popupLang">Bahasa</label>
      <select id="popupLang" class="smallInput" >
        <option value="id">Bahasa Indonesia</option>
        <option value="en">English</option>
        <option value="ms">Bahasa Melayu</option>
        <option value="su">Sunda</option>
      </select>
    </div>

    <div style="margin-top:6px; color:#aef9e9; font-size:13px">
      Catatan: Kirim dalam bahasa lokal yang dipilih; Lionor akan membalas sesuai bahasa tersebut.
    </div>

    <div class="popup-footer">
      <button class="btn ghost" id="cancelSettings">Batal</button>
      <button class="btn primary" id="saveSettings">Simpan</button>
    </div>
  </div>

  <script>
    console.log('hallo king zezy');

    // elements
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const chat = document.getElementById('chat');
    const input = document.getElementById('pertanyaan');
    const sendBtn = document.getElementById('sendBtn');
    const openSettingsBtn = document.getElementById('openSettingsBtn');
    const settingsPopup = document.getElementById('settingsPopup');
    const popupMode = document.getElementById('popupMode');
    const popupModel = document.getElementById('popupModel');
    const popupLang = document.getElementById('popupLang');
    const popupSpeed = document.getElementById('popupSpeed');
    const saveSettings = document.getElementById('saveSettings');
    const cancelSettings = document.getElementById('cancelSettings');
    const sideActiveMode = document.getElementById('sideActiveMode');
    const sideActiveModel = document.getElementById('sideActiveModel');
    const popupLangLabel = document.getElementById('popupLangLabel');
    const jumpBtn = document.getElementById('jumpBtn');

    // persistence keys
    const KEY_MODE = 'lionor_mode';
    const KEY_MODEL = 'lionor_model';
    const KEY_LANG = 'lionor_lang';
    const KEY_SPEED = 'lionor_speed';

    // defaults
    const defaults = {
      mode:'normal',
      model:'llama-3.3-70b',
      lang:'id',
      speed:'14'
    };

    // init from localStorage
    const savedMode = localStorage.getItem(KEY_MODE) || defaults.mode;
    const savedModel = localStorage.getItem(KEY_MODEL) || defaults.model;
    const savedLang = localStorage.getItem(KEY_LANG) || defaults.lang;
    const savedSpeed = localStorage.getItem(KEY_SPEED) || defaults.speed;

    // reflect initial UI
    popupMode.value = savedMode;
    popupModel.value = savedModel;
    popupLang.value = savedLang;
    popupSpeed.value = savedSpeed;
    sideActiveMode.textContent = popupMode.options[popupMode.selectedIndex].text;
    sideActiveModel.textContent = popupModel.value;
    popupLangLabel.textContent = popupLang.options[popupLang.selectedIndex].text;

    // menu toggle (no separate X)
    menuBtn.addEventListener('click', () => {
      const wasOpen = sideMenu.classList.contains('open');
      if (wasOpen) {
        sideMenu.classList.remove('open');
        menuBtn.textContent = '‚ò∞';
        sideMenu.setAttribute('aria-hidden','true');
      } else {
        sideMenu.classList.add('open');
        menuBtn.textContent = '√ó';
        sideMenu.setAttribute('aria-hidden','false');
      }
    });

    // settings popup open/close
    openSettingsBtn.addEventListener('click', () => {
      settingsPopup.classList.add('open');
      settingsPopup.setAttribute('aria-hidden','false');
      // load current
      popupMode.value = localStorage.getItem(KEY_MODE) || defaults.mode;
      popupModel.value = localStorage.getItem(KEY_MODEL) || defaults.model;
      popupLang.value = localStorage.getItem(KEY_LANG) || defaults.lang;
      popupSpeed.value = localStorage.getItem(KEY_SPEED) || defaults.speed;
    });
    cancelSettings.addEventListener('click', () => {
      settingsPopup.classList.remove('open');
      settingsPopup.setAttribute('aria-hidden','true');
    });

    // save settings
    saveSettings.addEventListener('click', () => {
      const mode = popupMode.value;
      const model = popupModel.value;
      const lang = popupLang.value;
      const speed = popupSpeed.value;

      localStorage.setItem(KEY_MODE, mode);
      localStorage.setItem(KEY_MODEL, model);
      localStorage.setItem(KEY_LANG, lang);
      localStorage.setItem(KEY_SPEED, speed);

      sideActiveMode.textContent = popupMode.options[popupMode.selectedIndex].text;
      sideActiveModel.textContent = model;
      popupLangLabel.textContent = popupLang.options[popupLang.selectedIndex].text;

      settingsPopup.classList.remove('open');
      settingsPopup.setAttribute('aria-hidden','true');
    });

    // keyboard: enter to send
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); sendMessage(); }
    });
    sendBtn.addEventListener('click', sendMessage);

    // mode -> default speed map (ms per char)
    const modeSpeedMap = {
      'tothepoint': 6,
      'normal': 14,
      'analisis': 20,
      'deep': 28,
      'santai': 10
    };

    // parse bold segments like (**bold**)
    function parseBoldSegments(text) {
      const segments = [];
      let idx = 0;
      const regex = /\(\*\*(.*?)\*\*\)/g;
      let m;
      while ((m = regex.exec(text)) !== null) {
        const before = text.slice(idx, m.index);
        if (before) segments.push({text: before, bold: false});
        segments.push({text: m[1], bold: true});
        idx = m.index + m[0].length;
      }
      const tail = text.slice(idx);
      if (tail) segments.push({text: tail, bold: false});
      return segments;
    }

    async function typeWithBold(container, message, speed = 14) {
      container.innerHTML = '';
      const segments = parseBoldSegments(message);
      const spanElems = segments.map(seg => {
        const sp = document.createElement('span');
        if (seg.bold) sp.className = 'boldSpan';
        sp.dataset.full = seg.text;
        sp.textContent = '';
        container.appendChild(sp);
        return sp;
      });
      for (let i=0;i<spanElems.length;i++){
        const sp = spanElems[i];
        const full = sp.dataset.full;
        for (let j=0;j<full.length;j++){
          sp.textContent += full.charAt(j);
          if ((chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 60) chat.scrollTop = chat.scrollHeight;
          await new Promise(r => setTimeout(r, speed));
        }
      }
    }

    function isAtBottom() {
      return (chat.scrollHeight - chat.scrollTop - chat.clientHeight) < 60;
    }

    function updateJumpButton() {
      const gen = chat.querySelector('.msg[data-generating="true"]');
      const shouldShow = !!gen && !isAtBottom();
      jumpBtn.style.display = shouldShow ? 'flex' : 'none';
    }
    chat.addEventListener('scroll', updateJumpButton);
    window.addEventListener('resize', updateJumpButton);
    jumpBtn.addEventListener('click', () => {
      const gen = chat.querySelector('.msg[data-generating="true"]') || chat.querySelector('.msg.ai:last-of-type');
      if (gen) gen.scrollIntoView({behavior:'smooth', block:'center'});
    });

    // quick local replies
    function autoReplyLocal(q) {
      const pert = q.toLowerCase().trim();
      if (pert === "hallo lionor" || pert === "halo lionor") return "Hallo juga! aku LIONOR AI Milik Zezy! Ada yang mau kamu tanyain hari ini?";
      if (pert.includes("siapa pemilik lionor")) return "LIONOR AI Beta adalah karya dari seorang kreator independen bernama Zezy.";
      if (pert.includes("lionor ai dari mana")) return "Lionor AI berasal dari Indonesia‚Äîdibangun dengan semangat lokal yang kental.";
      return null;
    }

    // post-process for 'santai' mode: simple replacement to elu/gua and tack "Bro, "
    function applySantaiStyle(text) {
      if (!text || typeof text !== 'string') return text;
      // avoid modifying content inside backticks or code blocks by simple heuristic: if contains ``` skip replacements
      if (text.includes('```')) {
        // still prefix Bro if not present
        if (!/^(\s*bro[,!:]?\s*)/i.test(text)) return 'Bro, ' + text;
        return text;
      }
      let t = text;
      // word-boundary replacements (case-insensitive)
      t = t.replace(/\bAku\b/g, 'Gua').replace(/\baku\b/g, 'gua');
      t = t.replace(/\bSaya\b/g, 'Gua').replace(/\bsaya\b/g, 'gua');
      t = t.replace(/\bKamu\b/g, 'Elu').replace(/\bkamu\b/g, 'elu');
      t = t.replace(/\bAnda\b/g, 'Elu').replace(/\banda\b/gi, 'elu');
      // ensure starts with "Bro, " if not already has bro-like greeting
      if (!/^(\s*(bro|bro,|bro:|bro!|bro\.)\s*)/i.test(t)) {
        t = 'Bro, ' + t;
      }
      return t;
    }

    // buildAnswerFromResponse tolerant
    function buildAnswerFromResponse(parsedOrText) {
      if (!parsedOrText) return "‚ö†Ô∏è Lionor gak ngerti. Coba tanya lagi ya.";
      if (typeof parsedOrText === 'object') {
        if (parsedOrText.answer) return parsedOrText.answer;
        if (parsedOrText.message) return parsedOrText.message;
        return JSON.stringify(parsedOrText).slice(0,1200);
      }
      return parsedOrText;
    }

    // main send
    let jumlahPertanyaan = parseInt(localStorage.getItem('jumlahPertanyaan') || '0');
    const LIMIT_HARIAN = 100;

    async function sendMessage() {
      const teks = input.value.trim();
      if (!teks) return;

      if (jumlahPertanyaan >= LIMIT_HARIAN) {
        const warn = document.createElement('div');
        warn.className = 'msg ai';
        chat.appendChild(warn);
        await typeWithBold(warn, "‚ö†Ô∏è Anda telah melebihi batas harian. Silakan upgrade ke Lionor AI Premium.", 6);
        return;
      }

      jumlahPertanyaan++;
      localStorage.setItem('jumlahPertanyaan', jumlahPertanyaan);

      // add user message
      const userMsg = document.createElement('div');
      userMsg.className = 'msg user';
      userMsg.textContent = teks;
      chat.appendChild(userMsg);
      chat.scrollTop = chat.scrollHeight;

      input.value = '';
      input.focus();

      // quick reply
      const quick = autoReplyLocal(teks);
      if (quick) {
        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai';
        chat.appendChild(aiMsg);
        await typeWithBold(aiMsg, quick, 6);
        return;
      }

      // placeholder ai message
      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg ai';
      aiMsg.dataset.generating = 'true';
      chat.appendChild(aiMsg);
      chat.scrollTop = chat.scrollHeight;
      updateJumpButton();

      // speed selection: explicit setting > mode map
      const savedSpeed = parseInt(localStorage.getItem(KEY_SPEED) || defaults.speed, 10);
      const modeFromStorage = localStorage.getItem(KEY_MODE) || defaults.mode;
      const finalSpeed = !isNaN(savedSpeed) ? savedSpeed : (modeSpeedMap[modeFromStorage] || 14);

      aiMsg.textContent = '‚è≥ Lionor mikir...';
      chat.scrollTop = chat.scrollHeight;

      try {
        const mode = encodeURIComponent(localStorage.getItem(KEY_MODE) || defaults.mode);
        const model = encodeURIComponent(localStorage.getItem(KEY_MODEL) || defaults.model);
        const lang = encodeURIComponent(localStorage.getItem(KEY_LANG) || defaults.lang);

        const controller = new AbortController();
        const timeoutMap = { 'tothepoint': 15000, 'normal': 30000, 'analisis': 45000, 'deep': 90000, 'santai': 30000 };
        const timeoutMs = timeoutMap[mode] || 30000;
        const timeout = setTimeout(() => controller.abort(), timeoutMs);

        const url = `/.netlify/functions/ask?q=${encodeURIComponent(teks)}&mode=${mode}&model=${model}&lang=${lang}`;

        const res = await fetch(url, { signal: controller.signal });
        clearTimeout(timeout);

        let raw = '';
        try { raw = await res.text(); } catch(e){ raw = ''; }
        let parsed = null;
        try { parsed = raw ? JSON.parse(raw) : null; } catch(e){ parsed = null; }

        let answer = buildAnswerFromResponse(parsed || raw);

        // if mode is santai, apply local style transform
        if ((localStorage.getItem(KEY_MODE) || defaults.mode) === 'santai') {
          answer = applySantaiStyle(answer);
        }

        await typeWithBold(aiMsg, answer, finalSpeed);

      } catch (err) {
        const errMsg = (err && err.name === 'AbortError') ? '‚ö†Ô∏è Permintaan timeout (terlalu lama).' : (`‚ö†Ô∏è Gagal ambil jawaban: ${err.message || err}`);
        await typeWithBold(aiMsg, errMsg, 8);
      } finally {
        delete aiMsg.dataset.generating;
        updateJumpButton();
        if (isAtBottom()) chat.scrollTop = chat.scrollHeight;
      }
    }

    // periodic update jump button
    setInterval(updateJumpButton, 600);

    input.focus();

    // expose for debug
    window._lionor = { sendMessage, applySantaiStyle, parseBoldSegments };
  </script>
</body>
</html>
