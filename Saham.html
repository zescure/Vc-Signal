<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Simulator - Mobile UI (ZCoin Connected)</title>
  <style>
    :root{
      --bg:#071021;
      --card:#0b1625;
      --muted:rgba(255,255,255,0.55);
      --accent:#ffd24a;
      --accent-2:#ffb86b;
      --danger:#ff7070;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#04101a 0%, #071826 100%);color:#dbeeff;}
    .app{max-width:420px;margin:18px auto;min-height:calc(100vh - 36px);border-radius:20px;overflow:hidden;box-shadow:0 10px 40px rgba(2,8,23,0.6);border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.008));display:flex;flex-direction:column;}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;gap:8px;background:linear-gradient(90deg, rgba(255,255,255,0.015), rgba(255,255,255,0.012));border-bottom:1px solid rgba(255,255,255,0.02);}
    .brand{display:flex;gap:10px;align-items:center}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(145deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:#062031;font-weight:800;font-size:18px;box-shadow:0 6px 18px rgba(255,210,74,0.08), inset 0 -6px 18px rgba(255,255,255,0.06);}
    .app-title{font-weight:700;font-size:15px}
    .app-sub{font-size:12px;color:var(--muted);margin-top:2px}
    .bal-card{background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));padding:8px 10px;border-radius:10px;display:flex;flex-direction:column;align-items:flex-end;min-width:120px;box-shadow:inset 0 -10px 30px rgba(0,0,0,0.2);}
    .bal-lbl{font-size:11px;color:var(--muted)}
    .bal-val{font-weight:800;color:#fff;font-size:16px}
    .user-row{display:flex;flex-direction:column;align-items:flex-end;font-size:12px}
    .user-info{color:var(--muted);font-size:12px}
    .btn{background:transparent;border:0;color:var(--muted);padding:6px 8px;border-radius:8px;font-weight:600;cursor:pointer}
    .btn:hover{background:rgba(255,255,255,0.02)}
    .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#041826;border:0;padding:8px 12px;border-radius:10px;font-weight:800;cursor:pointer}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .muted{color:var(--muted)}
    .content{padding:12px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto}
    .page{display:none}
    .page#page-home{display:block}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.01));padding:12px;border-radius:var(--radius);border:1px solid rgba(255,255,255,0.02);}
    #marketList{display:flex;flex-direction:column;gap:8px;max-height:240px;overflow:auto;padding-right:2px}
    .list-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:12px;background:var(--card);border:1px solid rgba(255,255,255,0.02);gap:8px;}
    .market-head{display:flex;justify-content:space-between;align-items:flex-start;gap:8px}
    .market-meta{display:flex;flex-direction:column;gap:4px}
    .market-price{font-weight:900;font-size:20px}
    .market-sub{font-size:12px;color:var(--muted)}
    .chart-wrap{height:220px;border-radius:12px;overflow:hidden;background:linear-gradient(180deg,#081926,#071426);display:flex;align-items:center;justify-content:center;border:1px solid rgba(255,255,255,0.02)}
    canvas{width:100%;height:100%;display:block}
    input[type="number"], input[type="text"], input[type="datetime-local"], select{
      background:transparent;border:1px solid rgba(255,255,255,0.04);
      padding:8px;border-radius:10px;color:#fff;font-size:14px;
    }
    #positionsList, #tradesList, #eventsList, #rightHistory, #adminVolList {display:flex;flex-direction:column;gap:8px;overflow:auto}
    .bottom-nav{display:flex;gap:6px;padding:10px;background:linear-gradient(180deg, rgba(0,0,0,0.06), rgba(0,0,0,0.03));align-items:center;justify-content:space-between;border-top:1px solid rgba(255,255,255,0.02);}
    .nav-btn{flex:1;display:flex;flex-direction:column;align-items:center;padding:8px;border-radius:10px;background:transparent;border:0;color:var(--muted);cursor:pointer;font-weight:700;}
    .nav-btn.active{background:rgba(255,255,255,0.02);color:var(--accent);box-shadow:inset 0 -6px 16px rgba(255,210,74,0.03)}
    #modalRoot{position:fixed;left:0;top:0;right:0;bottom:0;display:none;align-items:center;justify-content:center;z-index:200}
    .tiny{font-size:12px;color:var(--muted);}
    @media (max-width:420px){ .app{margin:10px} .chart-wrap{height:200px} }
  </style>
</head>

<body>
  <div class="app" role="application" aria-label="Market Simulator">
    <div class="topbar">
      <div class="brand">
        <div class="logo">ZP</div>
        <div>
          <div class="app-title">Zeepay Market</div>
          <div class="app-sub">Simulasi saham ‚Ä¢ realtime</div>
        </div>
      </div>

      <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px">
        <div class="bal-card">
          <div class="bal-lbl">Saldo (ZCoin)</div>
          <div id="bal" class="bal-val">0.00</div>
        </div>

        <!-- NEW: Deposit / Withdraw buttons -->
        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
          <button id="btnDeposit" class="btn-ghost">‚ûï Deposit</button>
          <button id="btnWithdraw" class="btn-ghost">‚ûñ Withdraw</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center">
          <div class="user-row">
            <div id="userInfo" class="user-info">not signed</div>
          </div>
          <button id="btnSignIn" class="btn">Sign in</button>
          <button id="btnSignOut" class="btn" style="display:none">Sign out</button>
        </div>
      </div>
    </div>

    <div class="content">
      <!-- HOME PAGE -->
      <div id="page-home" class="page">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800">Markets</div>
              <div class="small muted">Realtime daftar market</div>
            </div>
            <div style="display:flex;gap:8px;align-items:center">
              <button id="btnGotoMarket" class="btn-ghost">Market</button>
            </div>
          </div>
          <div id="marketList" style="margin-top:12px"></div>
        </div>

        <div class="card" style="display:flex;gap:10px;flex-direction:column">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Portfolio</div>
            <div style="display:flex;gap:8px">
              <button id="btnGotoPortfolio" class="btn-ghost">Buka</button>
            </div>
          </div>

          <div style="display:flex;gap:10px">
            <div style="flex:1">
              <div class="small muted">Positions</div>
              <div id="positionsList" style="max-height:140px;margin-top:8px"></div>
            </div>
            <div style="width:120px">
              <div class="small muted">Unreal P/L</div>
              <div id="totalPnl" style="font-weight:900;font-size:18px;margin-top:6px">0.00</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Recent ZCoin History</div>
            <div class="tiny muted">dari sistem ZCoin</div>
          </div>
          <div id="rightHistory" style="margin-top:10px;max-height:160px"></div>
        </div>
      </div>

      <!-- MARKET PAGE -->
      <div id="page-market" class="page">
        <div class="card">
          <div class="market-head">
            <div class="market-meta">
              <div id="marketName" style="font-weight:900;font-size:18px">-</div>
              <div class="market-sub"><span id="marketSymbol">-</span> ‚Ä¢ <span id="marketDesc" class="muted"></span></div>
            </div>
            <div style="text-align:right">
              <div id="marketPrice" class="market-price">0.00</div>
              <div class="small muted" id="marketVolDisplay">Vol x1</div>
            </div>
          </div>

          <div class="chart-wrap" style="margin-top:12px">
            <canvas id="chartCanvas"></canvas>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px;align-items:center">
            <input id="buyShares" type="number" placeholder="Jumlah lembar (min 100)" style="flex:1" value="100" />
            <button id="btnBuy" class="btn-primary">Beli</button>
            <button id="btnSell" class="btn-ghost">Jual</button>
          </div>

          <div class="small muted" style="margin-top:10px">
            * Trading memakai saldo yang sama dengan ZCoin Wallet (zcoin_balances/{uid})
          </div>
        </div>

        <div class="card" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Trades Terakhir</div>
          </div>
          <div id="tradesList" style="margin-top:10px;max-height:180px"></div>
        </div>
      </div>

      <!-- PORTFOLIO PAGE -->
      <div id="page-portfolio" class="page">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Portfolio</div>
            <div class="small muted">Manage posisi</div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <div style="flex:1">
              <div class="small muted">Posisi Terbuka</div>
              <div id="positionsList2" style="max-height:320px;margin-top:8px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- EVENTS PAGE -->
      <div id="page-events" class="page">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Events</div>
            <div class="small muted">coming soon</div>
          </div>
          <div class="small muted" style="margin-top:10px">
            Fitur event lu bisa lu sambung lagi nanti.
          </div>
        </div>
      </div>
    </div>

    <div class="bottom-nav">
      <button class="nav-btn active" data-page="home"><div class="nav-ico">üè†</div>Home</button>
      <button class="nav-btn" data-page="markets"><div class="nav-ico">üìà</div>Markets</button>
      <button class="nav-btn" data-page="portfolio"><div class="nav-ico">üíº</div>Portfolio</button>
      <button class="nav-btn" data-page="events"><div class="nav-ico">üìÖ</div>Events</button>
    </div>
  </div>

  <div id="modalRoot"></div>

  <!-- Firebase SDKs (v8) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <script>
    /* ------------------ CONFIG URL ------------------ */
    const SIGNIN_URL = '/register-login';

    // NEW: deposit & withdraw pages (ubah sesuai route lu)
    const DEPOSIT_URL = '/deposit.html';
    const WITHDRAW_URL = '/withdraw.html';

    /* FIREBASE CONFIG */
    const firebaseConfig = {
      apiKey: "AIzaSyDVUEZ3ZVmH4ld7LVnEq_L368wEJpEs-l8",
      authDomain: "zeepaylater-93a94.firebaseapp.com",
      projectId: "zeepaylater-93a94",
      storageBucket: "zeepaylater-93a94.appspot.com",
      messagingSenderId: "358065954807",
      appId: "1:358065954807:web:66619211fea82a4b2518f2"
    };

    const ADMIN_UID = 'viCOsJo4wHVFmhtpmMx1Wd4sDF52';

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /* ---------------- ZCOIN PATHS ---------------- */
    const ZCOIN_BALANCES_COLL = 'zcoin_balances';
    const ZCOIN_META_REF = db.collection('zcoin').doc('meta');

    const TOTAL_SUPPLY = 500_000_000_000;
    const INITIAL_AIRDROP = 1000;

    /* ---------------- APP STATE ---------------- */
    let currentUser = null;
    let balance = 0;

    let currentMarketId = null;
    let currentMarket = null;
    let marketsCache = {};
    let unsubscribeMarkets = null;
    let unsubscribeMarket = null;

    /* ---------------- UI REFS ---------------- */
    const balEl = document.getElementById('bal');
    const userInfoEl = document.getElementById('userInfo');
    const btnSignIn = document.getElementById('btnSignIn');
    const btnSignOut = document.getElementById('btnSignOut');

    const btnDeposit = document.getElementById('btnDeposit');
    const btnWithdraw = document.getElementById('btnWithdraw');

    const marketListEl = document.getElementById('marketList');
    const positionsListEl = document.getElementById('positionsList');
    const positionsListEl2 = document.getElementById('positionsList2');
    const tradesListEl = document.getElementById('tradesList');
    const rightHistoryEl = document.getElementById('rightHistory');

    /* ---------------- HELPERS ---------------- */
    function formatPrice(p){ return Number(p || 0).toFixed(2); }

    function mustLogin(){
      if(!currentUser) {
        alert('Lu harus login dulu biar saldo nyambung ke ZCoin.');
        window.open(SIGNIN_URL, '_blank');
        return false;
      }
      return true;
    }

    function setBalanceUI(val){
      balance = Number(val || 0);
      balEl.innerText = balance.toFixed(2);
    }

    function clampNumber(n){
      n = Number(n || 0);
      if(!isFinite(n)) return 0;
      return n;
    }

    /* ---------------- NEW: ECONOMY HELPERS ---------------- */
    async function ensureZcoinMeta(){
      const snap = await ZCOIN_META_REF.get();
      if(!snap.exists){
        await ZCOIN_META_REF.set({
          totalSupply: TOTAL_SUPPLY,
          circulatingSupply: 0,
          lockedSupply: TOTAL_SUPPLY, // NEW
          dynamicRatePer10: 10,
          bankLiquidityIDR: 100000,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } else {
        // migrate if lockedSupply not exist
        const data = snap.data() || {};
        if(typeof data.lockedSupply === 'undefined'){
          const total = data.totalSupply || TOTAL_SUPPLY;
          const circ = data.circulatingSupply || 0;
          const locked = Math.max(0, total - circ);
          await ZCOIN_META_REF.update({ lockedSupply: locked });
        }
      }
    }

    async function ensureUserZBalance(uid, displayName){
      const userRef = db.collection(ZCOIN_BALANCES_COLL).doc(uid);
      const snap = await userRef.get();
      if(snap.exists) return;

      if(INITIAL_AIRDROP > 0){
        await db.runTransaction(async tx=>{
          const metaSnap = await tx.get(ZCOIN_META_REF);
          if(!metaSnap.exists) throw new Error('ZCoin meta not found');
          const meta = metaSnap.data();

          const total = meta.totalSupply || TOTAL_SUPPLY;
          const circ = meta.circulatingSupply || 0;
          const locked = typeof meta.lockedSupply === 'number' ? meta.lockedSupply : (total - circ);

          if(INITIAL_AIRDROP > locked) throw new Error('Locked supply tidak cukup untuk airdrop');

          tx.set(userRef, {
            amount: INITIAL_AIRDROP,
            displayName: displayName || '-',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          const txDoc = userRef.collection('transactions').doc();
          tx.set(txDoc, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            amount: INITIAL_AIRDROP,
            type: 'airdrop',
            note: 'onboarding-airdrop'
          });

          tx.update(ZCOIN_META_REF, {
            circulatingSupply: circ + INITIAL_AIRDROP,
            lockedSupply: locked - INITIAL_AIRDROP
          });
        });
      } else {
        await userRef.set({
          amount: 0,
          displayName: displayName || '-',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      }
    }

    function subscribeUserBalance(uid){
      const ref = db.collection(ZCOIN_BALANCES_COLL).doc(uid);
      return ref.onSnapshot(snap=>{
        if(!snap.exists) return setBalanceUI(0);
        const amt = Number(snap.data().amount || 0);
        setBalanceUI(amt);
      });
    }

    async function loadZTxHistory(uid){
      rightHistoryEl.innerHTML = '';
      try{
        const col = db.collection(ZCOIN_BALANCES_COLL).doc(uid).collection('transactions');
        const snaps = await col.orderBy('timestamp','desc').limit(10).get();
        snaps.forEach(d=>{
          const t = d.data();
          const time = t.timestamp && t.timestamp.toDate ? t.timestamp.toDate().toLocaleString() : '';
          const div = document.createElement('div');
          div.className = 'list-item';
          div.innerHTML = `
            <div>
              <div style="font-weight:800">${t.amount>0?'+':''}${Number(t.amount||0).toFixed(2)} koin</div>
              <div class="small muted">${t.type || '-'} ‚Ä¢ ${time}</div>
            </div>
          `;
          rightHistoryEl.appendChild(div);
        });
      }catch(e){}
    }

    // NEW: open deposit/withdraw page
    btnDeposit.addEventListener('click', ()=>{
      if(!mustLogin()) return;
      window.open(DEPOSIT_URL, '_blank');
    });
    btnWithdraw.addEventListener('click', ()=>{
      if(!mustLogin()) return;
      window.open(WITHDRAW_URL, '_blank');
    });

    /* ---------------- AUTH ---------------- */
    let unsubscribeUserBal = null;

    btnSignIn.addEventListener('click', ()=> window.open(SIGNIN_URL,'_blank'));
    btnSignOut.addEventListener('click', ()=> auth.signOut());

    auth.onAuthStateChanged(async user=>{
      currentUser = user;

      if(unsubscribeUserBal){
        unsubscribeUserBal();
        unsubscribeUserBal = null;
      }

      if(user){
        userInfoEl.innerText = user.email || user.uid;
        btnSignIn.style.display = 'none';
        btnSignOut.style.display = 'inline-block';

        await ensureZcoinMeta();
        await ensureUserZBalance(user.uid, user.displayName || user.email || '-');

        unsubscribeUserBal = subscribeUserBalance(user.uid);
        await loadZTxHistory(user.uid);

      } else {
        userInfoEl.innerText = 'not signed';
        btnSignIn.style.display = 'inline-block';
        btnSignOut.style.display = 'none';
        setBalanceUI(0);
        rightHistoryEl.innerHTML = '';
      }
    });

    /* ---------------- NAV ---------------- */
    document.querySelectorAll('.nav-btn').forEach(b=>{
      b.addEventListener('click', ()=>{
        document.querySelectorAll('.nav-btn').forEach(x=>x.classList.remove('active'));
        b.classList.add('active');
        showPage(b.dataset.page);
      });
    });

    function showPage(name){
      ['page-home','page-market','page-portfolio','page-events'].forEach(id=>{
        document.getElementById(id).style.display='none';
      });
      if(name==='home') document.getElementById('page-home').style.display='block';
      if(name==='markets') document.getElementById('page-market').style.display='block';
      if(name==='portfolio') document.getElementById('page-portfolio').style.display='block';
      if(name==='events') document.getElementById('page-events').style.display='block';
    }

    document.getElementById('btnGotoMarket').addEventListener('click', ()=> showPage('markets'));
    document.getElementById('btnGotoPortfolio').addEventListener('click', ()=> showPage('portfolio'));

    /* ---------------- MARKETS LIST ---------------- */
    function subscribeMarkets(){
      if(unsubscribeMarkets) unsubscribeMarkets();
      unsubscribeMarkets = db.collection('markets').onSnapshot(snap=>{
        marketsCache = {};
        marketListEl.innerHTML = '';

        snap.forEach(doc=>{
          const m = doc.data();
          marketsCache[doc.id] = { ...m, id: doc.id };

          const el = document.createElement('div');
          el.className = 'list-item';
          el.innerHTML = `
            <div>
              <div style="font-weight:800">${m.name || doc.id}</div>
              <div class="small muted">${m.symbol || doc.id}</div>
            </div>
            <div style="text-align:right">
              <div style="font-weight:900">${formatPrice(m.price)}</div>
              <div style="margin-top:6px">
                <button class="btn btn-ghost">View</button>
              </div>
            </div>
          `;
          el.querySelector('button').addEventListener('click', ()=> selectMarket(doc.id));
          marketListEl.appendChild(el);
        });
      });
    }
    subscribeMarkets();

    /* ---------------- SELECT MARKET ---------------- */
    function selectMarket(marketId){
      currentMarketId = marketId;
      if(unsubscribeMarket) unsubscribeMarket();

      unsubscribeMarket = db.collection('markets').doc(marketId).onSnapshot(doc=>{
        if(!doc.exists) return;
        const m = doc.data();
        currentMarket = { ...m, id: doc.id };

        document.getElementById('marketName').innerText = m.name || doc.id;
        document.getElementById('marketSymbol').innerText = m.symbol || doc.id;
        document.getElementById('marketDesc').innerText = m.description || '';
        document.getElementById('marketPrice').innerText = formatPrice(m.price);
        document.getElementById('marketVolDisplay').innerText = 'Vol x' + (m.volatility || 1);
      });

      showPage('markets');
    }

    /* ---------------- POSITIONS (simple) ---------------- */
    let unsubscribePositions = null;

    function subscribePositions(){
      if(unsubscribePositions) unsubscribePositions();

      unsubscribePositions = db.collectionGroup('positions').onSnapshot(snap=>{
        const my = [];
        snap.forEach(d=>{
          const p = d.data();
          if(currentUser && p.userUID === currentUser.uid) my.push(p);
        });

        renderPositions(my);
      });
    }

    function renderPositions(list){
      positionsListEl.innerHTML = '';
      positionsListEl2.innerHTML = '';

      if(!currentUser){
        positionsListEl.innerHTML = `<div class="small muted">Login dulu buat lihat posisi.</div>`;
        positionsListEl2.innerHTML = `<div class="small muted">Login dulu buat lihat posisi.</div>`;
        return;
      }

      if(list.length === 0){
        positionsListEl.innerHTML = `<div class="small muted">Belum ada posisi.</div>`;
        positionsListEl2.innerHTML = `<div class="small muted">Belum ada posisi.</div>`;
        return;
      }

      list.slice(0,10).forEach(p=>{
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
          <div>
            <div style="font-weight:800">${p.marketName || p.marketId} ‚Ä¢ ${p.shares} lembar</div>
            <div class="small muted">Avg ${formatPrice(p.avgPrice)}</div>
          </div>
        `;
        positionsListEl.appendChild(el);
      });

      list.slice(0,50).forEach(p=>{
        const el = document.createElement('div');
        el.className = 'list-item';
        el.innerHTML = `
          <div>
            <div style="font-weight:800">${p.marketName || p.marketId}</div>
            <div class="small muted">${p.shares} lembar ‚Ä¢ Avg ${formatPrice(p.avgPrice)}</div>
          </div>
        `;
        positionsListEl2.appendChild(el);
      });
    }

    subscribePositions();

    /* ---------------- BUY / SELL (CONNECTED TO ZCOIN + PROFIT/LOSS ECONOMY) ---------------- */
    document.getElementById('btnBuy').addEventListener('click', buyShares);
    document.getElementById('btnSell').addEventListener('click', sellShares);

    async function buyShares(){
      if(!mustLogin()) return;
      if(!currentMarketId || !currentMarket) return alert('Pilih market dulu');

      const shares = Math.floor(Number(document.getElementById('buyShares').value || 0));
      if(!shares || shares < 100) return alert('Minimal pembelian 100 lembar');

      const price = clampNumber(currentMarket.price);
      const cost = shares * price;

      if(cost <= 0) return alert('Harga market invalid');
      if(cost > balance) return alert('Saldo ZCoin tidak cukup');

      const userRef = db.collection(ZCOIN_BALANCES_COLL).doc(currentUser.uid);

      try{
        await db.runTransaction(async tx=>{
          const uSnap = await tx.get(userRef);
          if(!uSnap.exists) throw new Error('Wallet ZCoin tidak ditemukan');

          const cur = clampNumber(uSnap.data().amount);
          if(cur < cost) throw new Error('Saldo ZCoin tidak cukup');

          // deduct wallet
          tx.update(userRef, {
            amount: cur - cost,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // write wallet tx history
          const txDoc = userRef.collection('transactions').doc();
          tx.set(txDoc, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            amount: -cost,
            type: 'market-buy',
            marketId: currentMarketId,
            shares: shares,
            price: price
          });

          // add position
          const posRef = db.collection('markets').doc(currentMarketId).collection('positions').doc();
          tx.set(posRef, {
            userUID: currentUser.uid,
            marketId: currentMarketId,
            marketName: currentMarket.name || currentMarketId,
            shares: shares,
            avgPrice: price,
            status: 'open',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // add trade log
          const tradeRef = db.collection('markets').doc(currentMarketId).collection('trades').doc();
          tx.set(tradeRef, {
            type: 'BUY',
            userUID: currentUser.uid,
            shares: shares,
            price: price,
            ts: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        await loadZTxHistory(currentUser.uid);
        alert(`Beli ${shares} lembar @ ${formatPrice(price)} sukses (saldo kepotong ZCoin).`);

      }catch(e){
        alert('Gagal buy: ' + (e.message || e));
      }
    }

    async function sellShares(){
      if(!mustLogin()) return;
      if(!currentMarketId || !currentMarket) return alert('Pilih market dulu');

      const sharesToSell = Math.floor(Number(document.getElementById('buyShares').value || 0));
      if(!sharesToSell || sharesToSell < 100) return alert('Minimal jual 100 lembar');

      const userRef = db.collection(ZCOIN_BALANCES_COLL).doc(currentUser.uid);
      const posColl = db.collection('markets').doc(currentMarketId).collection('positions');

      try{
        // ambil posisi open milik user
        const snap = await posColl.where('status','==','open').where('userUID','==',currentUser.uid).get();
        if(snap.empty) return alert('Lu belum punya posisi open di market ini');

        // total available shares
        let available = 0;
        const positions = [];
        snap.forEach(d=>{
          const p = d.data();
          positions.push({ ref: d.ref, data: p });
          available += Number(p.shares || 0);
        });

        if(available < sharesToSell) return alert('Lembar tidak cukup untuk dijual');

        const sellPrice = clampNumber(currentMarket.price);
        if(sellPrice <= 0) return alert('Harga market invalid');

        // ====== PROFIT/LOSS CALC (FIFO) ======
        // profit = (sellPrice - avgPrice) * shares
        let remaining = sharesToSell;
        let totalProfit = 0; // bisa minus juga
        for(const item of positions){
          if(remaining <= 0) break;
          const have = clampNumber(item.data.shares);
          const take = Math.min(have, remaining);
          const avg = clampNumber(item.data.avgPrice);
          const pnl = (sellPrice - avg) * take;
          totalProfit += pnl;
          remaining -= take;
        }

        // credit principal dari jual saham (ini uang hasil jual)
        const creditPrincipal = sharesToSell * sellPrice;

        await db.runTransaction(async tx=>{
          const metaSnap = await tx.get(ZCOIN_META_REF);
          if(!metaSnap.exists) throw new Error('ZCoin meta not found');
          const meta = metaSnap.data() || {};
          const total = meta.totalSupply || TOTAL_SUPPLY;
          const circ = clampNumber(meta.circulatingSupply);
          const locked = typeof meta.lockedSupply === 'number' ? clampNumber(meta.lockedSupply) : Math.max(0, total - circ);

          const uSnap = await tx.get(userRef);
          if(!uSnap.exists) throw new Error('Wallet ZCoin tidak ditemukan');
          const curBal = clampNumber(uSnap.data().amount);

          // 1) principal always masuk saldo (seperti sebelumnya)
          let newBal = curBal + creditPrincipal;

          // 2) apply profit/loss ke ekonomi koin
          // - profit: ambil dari lockedSupply -> masuk user
          // - loss: ambil dari user -> masuk lockedSupply
          let newCirc = circ;
          let newLocked = locked;

          const profitRounded = Number(totalProfit.toFixed(2)); // biar stabil

          if(profitRounded > 0){
            if(profitRounded > newLocked) throw new Error('Locked supply tidak cukup buat bayar profit user');
            newBal += profitRounded;
            newCirc += profitRounded;
            newLocked -= profitRounded;

            // log wallet profit
            const profitDoc = userRef.collection('transactions').doc();
            tx.set(profitDoc, {
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              amount: +profitRounded,
              type: 'trade-profit',
              marketId: currentMarketId,
              shares: sharesToSell,
              closePrice: sellPrice
            });
          }

          if(profitRounded < 0){
            const lossAbs = Math.abs(profitRounded);
            // NOTE: loss diambil dari saldo user
            if(lossAbs > newBal) throw new Error('Saldo tidak cukup buat menutup loss (koin ditarik balik ke locked supply)');
            newBal -= lossAbs;
            newCirc -= lossAbs;
            newLocked += lossAbs;

            // log wallet loss
            const lossDoc = userRef.collection('transactions').doc();
            tx.set(lossDoc, {
              timestamp: firebase.firestore.FieldValue.serverTimestamp(),
              amount: -lossAbs,
              type: 'trade-loss',
              marketId: currentMarketId,
              shares: sharesToSell,
              closePrice: sellPrice
            });
          }

          // update user wallet final
          tx.update(userRef, {
            amount: newBal,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });

          // log sell principal
          const txDoc = userRef.collection('transactions').doc();
          tx.set(txDoc, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            amount: +creditPrincipal,
            type: 'market-sell',
            marketId: currentMarketId,
            shares: sharesToSell,
            price: sellPrice
          });

          // update meta economy
          tx.update(ZCOIN_META_REF, {
            circulatingSupply: newCirc,
            lockedSupply: newLocked
          });

          // close/reduce positions FIFO
          let remainingClose = sharesToSell;
          for(const item of positions){
            if(remainingClose <= 0) break;

            const have = clampNumber(item.data.shares);
            const take = Math.min(have, remainingClose);
            const left = have - take;

            if(left <= 0){
              tx.update(item.ref, {
                shares: 0,
                status: 'closed',
                closedAt: firebase.firestore.FieldValue.serverTimestamp(),
                closePrice: sellPrice,
                realizedPnl: Number(((sellPrice - clampNumber(item.data.avgPrice)) * take).toFixed(2))
              });
            } else {
              tx.update(item.ref, {
                shares: left
              });
            }

            remainingClose -= take;
          }

          // trade log
          const tradeRef = db.collection('markets').doc(currentMarketId).collection('trades').doc();
          tx.set(tradeRef, {
            type: 'SELL',
            userUID: currentUser.uid,
            shares: sharesToSell,
            price: sellPrice,
            realizedPnl: Number(profitRounded.toFixed(2)),
            ts: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        await loadZTxHistory(currentUser.uid);

        const pnlTxt = totalProfit >= 0 ? `+${formatPrice(totalProfit)}` : `${formatPrice(totalProfit)}`;
        alert(`Jual ${sharesToSell} lembar @ ${formatPrice(sellPrice)} sukses.\nRealized P/L: ${pnlTxt} ZCoin\n(Ekonomi locked/circulating auto update)`);

      }catch(e){
        alert('Gagal sell: ' + (e.message || e));
      }
    }

    /* ---------------- CANVAS SIMPLE PLACEHOLDER ---------------- */
    const canvas = document.getElementById('chartCanvas');
    const ctx = canvas.getContext('2d');
    function resizeCanvas(){
      const r = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = Math.floor(r.width * dpr);
      canvas.height = Math.floor(r.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      draw();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function draw(){
      const w = canvas.getBoundingClientRect().width;
      const h = canvas.getBoundingClientRect().height;
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.font = '14px Arial';
      ctx.fillText('Chart placeholder (lu bisa sambung engine lama lu lagi)', 10, 24);
    }
  </script>
</body>
</html>
