<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LIONOR Chat</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #0e0f11;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      position: fixed;
      top: 0;
      width: 96%;
      background: #1a1d24;
      padding: 16px;
      text-align: center;
      font-size: 1.4em;
      color: #00ffe7;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.5);
      z-index: 10;
    }
    #chat {
      flex: 1;
      padding: 90px 20px 100px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .msg {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    .user {
      align-self: flex-end;
      background: #00ffe7;
      color: black;
      font-weight: bold;
    }
    .ai {
      align-self: flex-start;
      background: #20242f;
    }
    #input-area {
      position: fixed;
      bottom: 0;
      width: 96%;
      display: flex;
      padding: 15px;
      background: #16181f;
      border-top: 1px solid #333;
      z-index: 10;
    }
    input[type="text"] {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      background: #252932;
      color: #fff;
      font-size: 1em;
    }
    button {
      margin-left: 10px;
      padding: 12px 20px;
      background-color: #00ffe7;
      color: #10131a;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    button:hover { background-color: #00d1bf; }

    /* menu */
    #menuBtn {
      position: fixed;
      top: 8px;
      left: 8px;
      width: 48px;
      height: 48px;
      background: none;
      border: none;
      cursor: pointer;
      color: #00ffe7;
      font-size: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1100;
      padding: 0;
    }
    #sideMenu {
      position: fixed;
      top: 0;
      left: -100%;
      width: 240px;
      height: 100vh;
      background: #1a1d24;
      overflow-y: auto;
      z-index: 998;
      transition: left 0.3s ease;
    }
    #sideMenu.open { left: 0; }
    #closeMenuBtn {
      background: none;
      border: none;
      color: #00ffe7;
      font-size: 24px;
      position: absolute;
      top: 16px;
      right: 16px;
      cursor: pointer;
    }
    #sideMenu ul { list-style: none; padding: 0; margin: 0; padding-top: 60px; }
    #sideMenu li { padding: 15px 20px; border-bottom: 1px solid #444; cursor: pointer; }
    #sideMenu li:hover { background: #333; }
    .menu-header {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      background: #2a2b2f;
      padding: 16px;
      font-size: 18px;
      font-weight: bold;
      border-bottom: 1px solid #444;
      color: #00ffe7;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>LIONOR2 AI Beta</header>
  <button id="menuBtn">‚ò∞</button>

  <div id="sideMenu" class="hidden">
    <div class="menu-header">Lionor AI</div>
    <button id="closeMenuBtn">‚úï</button>
    <ul>
  <li onclick="alert('üë§ Pemilik Lionor: Zezy ‚Äî developer & trader muda yang membangun AI ini dari nol, mulai dari konsep, UI, hingga logic core.')">
    Profil Pemilik
  </li>

  <li onclick="alert('üõ∞Ô∏è Tentang Lionor: Lionor AI adalah asisten AI lokal yang terus berkembang. Meski dirancang dan dibangun sendiri oleh Zezy, Lionor memanfaatkan kekuatan model besar dari Groq, Anthropic, dan OpenAI untuk memberikan respon cepat dan akurat.')">
    Tentang Kami
  </li>

  <li onclick="alert('üîê Privasi: Pertanyaan tidak disimpan secara permanen. Data hanya diproses oleh server untuk memberikan jawaban, tanpa pelacakan jangka panjang.')">
    Kebijakan Privasi
  </li>

  <li onclick="alert('üáÆüá© Dukungan: Terima kasih telah mendukung pengembangan AI lokal buatan anak negeri. Lionor terus diperbarui dan ditingkatkan seiring waktu.')">
    Support AI Lokal
  </li>
</ul>
  </div>

  <div id="chat"></div>

  <div id="input-area">
    <input type="text" id="pertanyaan" placeholder="Tulis pesan..." />
    <button onclick="kirimPertanyaan()">Kirim</button>
  </div>

  <script>
  // === AUTO REPLY MANUAL ===
  const autoReply = (q) => {
    const pertanyaan = q.toLowerCase().trim();
    if (pertanyaan === "siapa pemilik lionor ai" || pertanyaan === "siapa pemilik lionor" || pertanyaan === "lionor ai punya siapa" || pertanyaan === "lionor ai milik siapa" || pertanyaan === "punya siapa lionor ai") {
      return `LIONOR AI Beta adalah karya dari seorang kreator independen bernama Zezy.

Ia bukan bagian dari korporasi besar atau institusi resmi manapun. Zezy membangun Lionor AI dengan semangat keterbukaan, pendidikan mandiri, dan idealisme.`;
    }

    if (pertanyaan === "lionor ai dari mana") {
      return `Lionor AI berasal dari Indonesia‚Äîdibangun dengan semangat lokal yang kental namun tetap ingin punya kualitas global.`;
    }

    if (pertanyaan === "apa visi misi lionor ai") {
      return `Visi Lionor AI: menyederhanakan yang rumit dan membuka akses teknologi.`;
    }

    if (pertanyaan === "siapa zezy") {
      return `Zezy adalah pengembang di balik Lionor: trader, developer, autodidak.`;
    }

    if (pertanyaan === "hallo lionor" || pertanyaan === "halo lionor") {
      return "Hallo juga! aku LIONOR AI Milik Zezy! Ada yang mau kamu tanyain hari ini?";
    }

    if (pertanyaan.includes("siapa kamu")) {
      return "Aku Lionor AI Beta, asisten digital yang siap membantu kamu kapan saja!";
    }

    if (pertanyaan.includes("makasih") || pertanyaan.includes("terima kasih")) {
      return "Sama-sama yaa, aku senang bisa bantu üòä";
    }

    return null;
  };

  // === BATAS PERTANYAAN HARIAN ===
  let jumlahPertanyaan = parseInt(localStorage.getItem('jumlahPertanyaan') || '0');
  const LIMIT_HARIAN = 100;

  const chat = document.getElementById('chat');
  const input = document.getElementById('pertanyaan');

  let autoScroll = true;
  chat.addEventListener('scroll', () => {
    const threshold = 50;
    const atBottom = chat.scrollHeight - chat.scrollTop - chat.clientHeight < threshold;
    autoScroll = atBottom;
  });

  async function ketikEfek(element, text, delay = 4) {
    element.textContent = '';
    for (let i = 0; i < text.length; i++) {
      element.textContent += text.charAt(i);
      if (autoScroll) chat.scrollTop = chat.scrollHeight;
      await new Promise(r => setTimeout(r, delay));
    }
  }

  // jawaban jam sekarang (dipakai sebelum fetch)
  function jawabJamSekarang(teks) {
    const kataKunci = ['jam berapa', 'waktu sekarang', 'sekarang jam', 'berapa jam'];
    for (const kata of kataKunci) {
      if (teks.toLowerCase().includes(kata)) {
        const wibDate = new Date().toLocaleString('id-ID', { timeZone: 'Asia/Jakarta', hour12: false });
        return `Sekarang pukul ${wibDate}`;
      }
    }
    return null;
  }

  // Helper: format error/response jadi teks
  function buildAnswerFromResponse(res, parsed, rawText) {
    // prioritas: parsed.answer -> parsed.error.message -> parsed.message -> parsed.choices -> rawText -> statusText
    if (parsed) {
      if (parsed.answer) return parsed.answer;
      if (parsed.error && parsed.error.message) {
        const code = parsed.error.code ? ` (${parsed.error.code})` : '';
        return `‚ö†Ô∏è API error${code}: ${parsed.error.message}`;
      }
      if (parsed.message) return `‚ö†Ô∏è ${parsed.message}`;
      // choices (OpenAI-style)
      try {
        const ch = parsed.choices;
        if (Array.isArray(ch) && ch.length > 0) {
          const m = ch[0].message?.content || ch[0].text;
          if (m) return m;
        }
      } catch (e) {}
      // fallback show small JSON summary
      return `‚ö†Ô∏è Response (json): ${JSON.stringify(parsed).slice(0, 300)}`;
    }

    // not JSON
    if (rawText) {
      // if raw text short, show it, else truncate
      return rawText.length < 1000 ? rawText : rawText.slice(0, 1000) + '...';
    }

    // last resort
    return `‚ö†Ô∏è Server error ${res.status}: ${res.statusText || 'Unknown'}`;
  }

  // === KIRIM PERTANYAAN KE CHATBOX ===
  async function kirimPertanyaan() {
    const teks = input.value.trim();
    if (!teks) return;

    jumlahPertanyaan = parseInt(localStorage.getItem('jumlahPertanyaan') || '0');

    if (jumlahPertanyaan >= LIMIT_HARIAN) {
      const aiMsg = document.createElement('div');
      aiMsg.className = 'msg ai';
      chat.appendChild(aiMsg);
      await ketikEfek(aiMsg, "‚ö†Ô∏è Anda telah melebihi batas harian. Silakan upgrade ke Lionor AI Premium.");
      // tampilkanPopupPembayaran(); // optional
      return;
    }

    jumlahPertanyaan++;
    localStorage.setItem('jumlahPertanyaan', jumlahPertanyaan);

    const userMsg = document.createElement('div');
    userMsg.className = 'msg user';
    userMsg.textContent = teks;
    chat.appendChild(userMsg);

    input.value = '';
    input.focus();

    // cek auto-reply lokal dulu
    const jawabanCepat = autoReply ? autoReply(teks) : null;
    const jamNow = jawabJamSekarang(teks);
    const aiMsg = document.createElement('div');
    aiMsg.className = 'msg ai';
    chat.appendChild(aiMsg);

    if (autoScroll) chat.scrollTop = chat.scrollHeight;

    if (jawabanCepat) {
      await ketikEfek(aiMsg, jawabanCepat);
      return;
    }
    if (jamNow) {
      await ketikEfek(aiMsg, jamNow);
      return;
    }

    await ketikEfek(aiMsg, '‚è≥ Lionor mikir...');

    try {
      // timeout helper (so user can get message instead of hanging)
      const controller = new AbortController();
      const timeoutMs = 15000; // 15s
      const timeout = setTimeout(() => controller.abort(), timeoutMs);

      const res = await fetch(`/.netlify/functions/ask?q=${encodeURIComponent(teks)}`, { signal: controller.signal });

      clearTimeout(timeout);

      // always try to read as text first (to support non-json error bodies)
      let rawText = null;
      try {
        rawText = await res.text();
      } catch (e) {
        rawText = null;
      }

      // try parse JSON
      let parsed = null;
      try { parsed = rawText ? JSON.parse(rawText) : null; } catch (e) { parsed = null; }

      // Build user-friendly answer string
      const answerText = buildAnswerFromResponse(res, parsed, rawText);

      await ketikEfek(aiMsg, answerText || "‚ö†Ô∏è Lionor gak ngerti. Coba tanya dengan cara lain ya.");
    } catch (err) {
      // network / timeout / abort / other error
      let errMsg = err && err.name === 'AbortError' ? '‚ö†Ô∏è Permintaan timeout (terlalu lama).' : (`‚ö†Ô∏è Gagal ambil jawaban: ${err.message || err}`);
      // tampilkan alasan langsung
      await ketikEfek(aiMsg, errMsg);
    }

    if (autoScroll) chat.scrollTop = chat.scrollHeight;
  }

  // listener enter
  input.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      kirimPertanyaan();
    }
  });

  // menu toggles
  const menuBtn = document.getElementById('menuBtn');
  const sideMenu = document.getElementById('sideMenu');
  const closeMenuBtn = document.getElementById('closeMenuBtn');

  menuBtn.onclick = () => { sideMenu.classList.add('open'); };
  closeMenuBtn.onclick = () => { sideMenu.classList.remove('open'); };

  // small UX: autofocus
  input.focus();
  </script>
</body>
</html>
